{% extends "base.html" %}

{% block title %}Calculadora de Servi√ßos - Passos 1 e 2{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mt-4">
        <i class="fas fa-tools text-primary"></i>
        Calculadora de Servi√ßos
    </h1>

    <!-- Passo 1 -->
    <div id="passo1" style="display: block;">
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-building"></i>
                    Passo 1: Dados da Empresa
                </h2>
            </div>
            <div class="card-body">
                <form id="formPasso1" class="row g-3">
                    <div class="col-12">
                        <label for="cnpj" class="form-label">
                            <i class="fas fa-id-card text-muted"></i>
                            CNPJ
                        </label>
                        <div class="input-group">
                            <input type="text" id="cnpj" name="cnpj" class="form-control"
                                   placeholder="00.000.000/0000-00" required>
                            <button type="button" id="consultarCNPJ" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i>
                                Consultar
                            </button>
                        </div>
                        <div class="form-text">Digite apenas n√∫meros</div>
                    </div>

                    <div class="col-12">
                        <label for="razao_social" class="form-label">
                            <i class="fas fa-building text-muted"></i>
                            Raz√£o Social
                        </label>
                        <input type="text" id="razao_social" name="razao_social"
                               class="form-control" readonly>
                    </div>

                    <div class="col-12">
                        <label for="endereco" class="form-label">
                            <i class="fas fa-map-marker-alt text-muted"></i>
                            Endere√ßo
                        </label>
                        <textarea id="endereco" name="endereco" class="form-control"
                                  rows="3" readonly></textarea>
                    </div>

                    <div class="col-md-6">
                        <label for="numero_processo" class="form-label">
                            <i class="fas fa-file-alt text-muted"></i>
                            N√∫mero do Processo
                        </label>
                        <input type="text" id="numero_processo" name="numero_processo"
                               class="form-control" placeholder="Ex: 001/2024" required>
                    </div>

                    <div class="col-md-6">
                        <label for="validade_proposta" class="form-label">
                            <i class="fas fa-calendar text-muted"></i>
                            Validade da Proposta (dias)
                        </label>
                        <input type="number" id="validade_proposta" name="validade_proposta"
                               class="form-control" placeholder="60" min="1" required>
                    </div>

                    <div class="col-md-6">
                        <label for="prazo_pagamento" class="form-label">
                            <i class="fas fa-credit-card text-muted"></i>
                            Prazo de Pagamento
                        </label>
                        <input type="text" id="prazo_pagamento" name="prazo_pagamento"
                               class="form-control" placeholder="Ex: 30 dias" required>
                    </div>

                    <div class="col-md-6">
                        <label for="local_execucao" class="form-label">
                            <i class="fas fa-map-pin text-muted"></i>
                            Local de Execu√ß√£o
                        </label>
                        <input type="text" id="local_execucao" name="local_execucao"
                               class="form-control" placeholder="Ex: S√£o Paulo - SP" required>
                    </div>

                    <div class="col-md-6">
                        <label for="prazo_execucao" class="form-label">
                            <i class="fas fa-clock text-muted"></i>
                            Prazo de Execu√ß√£o (dias)
                        </label>
                        <input type="number" id="prazo_execucao" name="prazo_execucao"
                               class="form-control" placeholder="30" min="1" required>
                    </div>

                    <div class="col-12 text-center mt-4">
                        <button type="button" id="salvarPasso1" class="btn btn-success btn-lg">
                            <i class="fas fa-arrow-right"></i>
                            Salvar e Avan√ßar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Passo 2 -->
    <div id="passo2" style="display: none;">
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-success text-white">
                <h2 class="mb-0">
                    <i class="fas fa-cogs"></i>
                    Passo 2: Cadastro de Lotes e Servi√ßos
                </h2>
            </div>
            <div class="card-body">
                <!-- Progresso -->
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>

                <!-- Lotes Container -->
                <div id="lotesContainer"></div>

                <div class="text-center mt-3">
                    <button type="button" id="adicionarLote" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle"></i>
                        Adicionar Lote
                    </button>
                </div>

                <!-- Despesas Vari√°veis -->
                <div class="card mt-4">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="mb-0">
                            <i class="fas fa-receipt"></i>
                            Despesas Vari√°veis
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="formDespesas" class="row g-3">
                            <div class="col-md-6">
                                <label for="nomeDespesa" class="form-label">Nome da Despesa</label>
                                <input type="text" id="nomeDespesa" class="form-control"
                                       placeholder="Ex: Transporte, Hospedagem">
                            </div>
                            <div class="col-md-4">
                                <label for="valorDespesa" class="form-label">Valor (R$)</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" id="valorDespesa" step="0.01"
                                           class="form-control" placeholder="0,00">
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" id="adicionarDespesa" class="btn btn-warning w-100">
                                    <i class="fas fa-plus"></i>
                                    Adicionar
                                </button>
                            </div>
                        </form>

                        <div class="table-responsive mt-3">
                            <table id="tabelaDespesas" class="table table-hover">
                                <thead class="table-warning">
                                    <tr>
                                        <th><i class="fas fa-tag"></i> Nome da Despesa</th>
                                        <th><i class="fas fa-dollar-sign"></i> Valor (R$)</th>
                                        <th><i class="fas fa-tools"></i> A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Resumo -->
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">
                            <i class="fas fa-chart-line"></i>
                            Resumo Financeiro
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-minus-circle"></i>
                                            Custos
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <th>Custo Total dos Servi√ßos</th>
                                                <td id="resumoCustoTotal" class="text-end fw-bold">R$ 0,00</td>
                                            </tr>
                                            <tr>
                                                <th>Total de Despesas</th>
                                                <td id="totalDespesas" class="text-end fw-bold">R$ 0,00</td>
                                            </tr>
                                            <tr>
                                                <th>Imposto Total</th>
                                                <td id="resumoImpostoTotal" class="text-end fw-bold">R$ 0,00</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-plus-circle"></i>
                                            Receitas
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <th>Valor de Venda Total</th>
                                                <td id="resumoValorVendaTotal" class="text-end fw-bold">R$ 0,00</td>
                                            </tr>
                                            <tr class="table-success">
                                                <th><strong>Lucro Total</strong></th>
                                                <td id="resumoLucroTotal" class="text-end fw-bold fs-5">R$ 0,00</td>
                                            </tr>
                                            <tr>
                                                <th>Margem de Lucro</th>
                                                <td id="resumoMargemLucro" class="text-end fw-bold">0%</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finalizar -->
                <div class="text-center mt-4">
                    <button type="button" id="finalizarPrecificacao" class="btn btn-success btn-lg">
                        <i class="fas fa-check-circle"></i>
                        Finalizar Precifica√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Recupera√ß√£o de Sess√£o -->
<div class="modal fade" id="recoveryModal" tabindex="-1" aria-labelledby="recoveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="recoveryModalLabel">
                    <i class="fas fa-history"></i> Recuperar Sess√£o
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-save fa-3x text-primary mb-3"></i>
                <h6>Encontramos uma precifica√ß√£o de servi√ßos em andamento!</h6>
                <p class="text-muted">Voc√™ gostaria de continuar de onde parou ou iniciar uma nova precifica√ß√£o?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success me-2" id="continuarSessao">
                    <i class="fas fa-play"></i> Continuar
                </button>
                <button type="button" class="btn btn-outline-secondary" id="novaSessao">
                    <i class="fas fa-plus"></i> Nova Precifica√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para Notifica√ß√µes -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="autoSaveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-save me-2"></i>
            <strong class="me-auto">Salvamento Autom√°tico</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Dados salvos automaticamente!
        </div>
    </div>
</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<script>
document.addEventListener("DOMContentLoaded", () => {
    const basePath = "/precificaja";
    const lotesContainer = document.getElementById("lotesContainer");
    const tabelaDespesas = document.getElementById("tabelaDespesas").querySelector("tbody");
    const salvarPasso1Button = document.getElementById("salvarPasso1");
    const finalizarButton = document.getElementById("finalizarPrecificacao");
    const adicionarLoteButton = document.getElementById("adicionarLote");
    const adicionarDespesaButton = document.getElementById("adicionarDespesa");
    const consultarCNPJButton = document.getElementById("consultarCNPJ");

    // Elementos do resumo
    const resumoCustoTotal = document.getElementById("resumoCustoTotal");
    const resumoImpostoTotal = document.getElementById("resumoImpostoTotal");
    const resumoValorVendaTotal = document.getElementById("resumoValorVendaTotal");
    const resumoLucroTotal = document.getElementById("resumoLucroTotal");
    const resumoMargemLucro = document.getElementById("resumoMargemLucro");
    const totalDespesasElem = document.getElementById("totalDespesas");

    // Vari√°veis globais
    let propostaId = null;
    let contadorLotes = 0;
    let impostoVenda = 0;

    // ===== SISTEMA DE RECUPERA√á√ÉO DE SESS√ÉO =====

    // Fun√ß√£o para verificar se h√° sess√£o existente
    async function checkExistingSession() {
        try {
            const response = await fetch('/precificaja/servicos/sessao/verificar');
            if (response.ok) {
                const data = await response.json();
                if (data.tem_sessao) {
                    console.log('‚úÖ Sess√£o encontrada, mostrando modal de recupera√ß√£o');
                    showRecoveryModal();
                } else {
                    console.log('‚ÑπÔ∏è Nenhuma sess√£o encontrada');
                    initCalculadora();
                }
            } else {
                console.log('‚ÑπÔ∏è Erro ao verificar sess√£o, iniciando normalmente');
                initCalculadora();
            }
        } catch (error) {
            console.error('‚ùå Erro ao verificar sess√£o:', error);
            initCalculadora();
        }
    }

    // ‚úÖ VERIFICA√á√ÉO DE AUTENTICA√á√ÉO ADICIONADA
    async function verificarAutenticacao() {
        try {
            const response = await fetch('/precificaja/api/check-session');
            return response.ok;
        } catch (error) {
            console.error('Erro ao verificar autentica√ß√£o:', error);
            return false;
        }
    }

    // Fun√ß√£o para criar sess√£o vazia
    function createEmptySession() {
        return {
            passo1: {},
            passo2: {
                lotes: [],
                despesas: []
            },
            passo_atual: 1
        };
    }

    // Fun√ß√£o para salvar sess√£o no backend
    async function saveSession(session) {
        try {
            const response = await fetch('/precificaja/servicos/sessao/salvar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dados_sessao: session,
                    passo_atual: session.passo_atual
                })
            });

            if (response.ok) {
                console.log('‚úÖ Sess√£o salva no backend');
                showAutoSaveToast();

                // Backup no localStorage
                localStorage.setItem('calculadora_servicos_session', JSON.stringify(session));
            } else {
                console.error('‚ùå Erro ao salvar sess√£o no backend');
                // Salvar apenas no localStorage como fallback
                localStorage.setItem('calculadora_servicos_session', JSON.stringify(session));
            }
        } catch (error) {
            console.error('‚ùå Erro ao salvar sess√£o:', error);
            // Salvar apenas no localStorage como fallback
            localStorage.setItem('calculadora_servicos_session', JSON.stringify(session));
        }
    }

    // Fun√ß√£o para carregar sess√£o do backend
    async function loadSession() {
        try {
            const response = await fetch('/precificaja/servicos/sessao/carregar');
            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ Sess√£o carregada do backend');
                return data.dados_sessao;
            } else {
                console.log('‚ÑπÔ∏è Nenhuma sess√£o no backend, tentando localStorage');
                // Fallback para localStorage
                const localSession = localStorage.getItem('calculadora_servicos_session');
                return localSession ? JSON.parse(localSession) : null;
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar sess√£o do backend:', error);
            // Fallback para localStorage
            const localSession = localStorage.getItem('calculadora_servicos_session');
            return localSession ? JSON.parse(localSession) : null;
        }
    }

    // Fun√ß√£o para limpar sess√£o
    async function clearSession() {
        try {
            await fetch('/precificaja/servicos/sessao/limpar', { method: 'DELETE' });
            localStorage.removeItem('calculadora_servicos_session');
            console.log('‚úÖ Sess√£o limpa');
        } catch (error) {
            console.error('‚ùå Erro ao limpar sess√£o:', error);
            localStorage.removeItem('calculadora_servicos_session');
        }
    }

    // Fun√ß√£o para mostrar toast de salvamento autom√°tico
    function showAutoSaveToast() {
        const toastElement = document.getElementById('autoSaveToast');
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }

    // Fun√ß√£o debounce para otimizar salvamentos
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Fun√ß√£o para verificar se h√° dados no formul√°rio
    function hasFormData() {
        const formInputs = document.querySelectorAll('#formPasso1 input, #formPasso1 textarea');
        for (let input of formInputs) {
            if (input.value.trim() !== '') {
                return true;
            }
        }
        return false;
    }

    // Fun√ß√£o para salvar dados do Passo 1
    async function savePasso1Data() {
        try {
            const session = await loadSession() || createEmptySession();

            // Capturar dados do formul√°rio
            const formData = new FormData(document.getElementById("formPasso1"));
            const data = Object.fromEntries(formData.entries());

            // Atualizar sess√£o
            session.passo1 = {
                cnpj: data.cnpj || '',
                razao_social: data.razao_social || '',
                endereco: data.endereco || '',
                numero_processo: data.numero_processo || '',
                validade_proposta: data.validade_proposta || '',
                prazo_pagamento: data.prazo_pagamento || '',
                local_execucao: data.local_execucao || '',
                prazo_execucao: data.prazo_execucao || ''
            };
            session.passo_atual = 1;

            await saveSession(session);
        } catch (error) {
            console.error('‚ùå Erro ao salvar dados do Passo 1:', error);
            // N√£o bloquear a interface por erro de salvamento
        }
    }

    // Fun√ß√£o para salvar dados do Passo 2 (MELHORADA)
    async function savePasso2Data() {
        try {
            const session = await loadSession() || createEmptySession();

            // Capturar lotes com mais detalhes de debug
            const lotes = [];
            const loteDivs = lotesContainer.querySelectorAll(".lote");

            console.log(`üíæ Salvando ${loteDivs.length} lotes`);

            loteDivs.forEach((loteDiv, loteIndex) => {
                const nomeLoteInput = loteDiv.querySelector(".nomeLote");
                const nomeLote = nomeLoteInput ? nomeLoteInput.value.trim() : '';

                console.log(`üíæ Processando lote ${loteIndex + 1}: "${nomeLote}"`);

                const servicos = [];
                const servicoLinhas = loteDiv.querySelectorAll(".servicosContainer tr");

                console.log(`üíæ Lote ${loteIndex + 1} tem ${servicoLinhas.length} servi√ßos`);

                servicoLinhas.forEach((linha, servicoIndex) => {
                    const servico = {
                        nome: linha.querySelector(".nomeServico")?.value?.trim() || '',
                        unidade_medida: linha.querySelector(".unidade")?.value?.trim() || '',
                        quantidade: parseFloat(linha.querySelector(".quantidade")?.value?.replace(',', '.')) || 0,
                        custo_unitario: parseFloat(linha.querySelector(".custoUnitario")?.value?.replace(',', '.')) || 0,
                        valor_venda: parseFloat(linha.querySelector(".valorUnitarioVenda")?.value?.replace(',', '.')) || 0
                    };

                    console.log(`üíæ Servi√ßo ${servicoIndex + 1}:`, servico);
                    servicos.push(servico);
                });

                if (nomeLote) {
                    const loteData = { nome: nomeLote, servicos };
                    console.log(`üíæ Lote ${loteIndex + 1} salvo:`, loteData);
                    lotes.push(loteData);
                } else {
                    console.log(`‚ö†Ô∏è Lote ${loteIndex + 1} ignorado (sem nome)`);
                }
            });

            // Capturar despesas
            const despesas = [];
            const despesaLinhas = tabelaDespesas.querySelectorAll("tr");

            console.log(`üíæ Salvando ${despesaLinhas.length} despesas`);

            despesaLinhas.forEach((linha, index) => {
                if (linha.children.length >= 2) {
                    const despesa = {
                        nome: linha.children[0].textContent.trim(),
                        valor: parseFloat(linha.children[1].textContent.replace(/[^\d,-]+/g, "").replace(",", ".")) || 0
                    };
                    console.log(`üíæ Despesa ${index + 1}:`, despesa);
                    despesas.push(despesa);
                }
            });

            // Atualizar sess√£o
            session.passo2.lotes = lotes;
            session.passo2.despesas = despesas;
            session.passo_atual = 2;

            // Manter proposta_id se existir
            if (propostaId) {
                session.passo2.proposta_id = propostaId;
            }

            console.log('üíæ Dados do Passo 2 preparados para salvamento:', {
                lotes: lotes.length,
                despesas: despesas.length,
                proposta_id: propostaId
            });

            await saveSession(session);
            console.log('‚úÖ Dados do Passo 2 salvos com sucesso');
        } catch (error) {
            console.error('‚ùå Erro ao salvar dados do Passo 2:', error);
            // N√£o bloquear a interface por erro de salvamento
        }
    }

    // Fun√ß√£o para carregar dados do Passo 1
    function loadPasso1Data(session) {
        try {
            const passo1Data = session.passo1;

            // Preencher campos do formul√°rio
            Object.keys(passo1Data).forEach(key => {
                const element = document.getElementById(key);
                if (element && passo1Data[key]) {
                    element.value = passo1Data[key];
                }
            });

            console.log('‚úÖ Dados do Passo 1 carregados');
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados do Passo 1:', error);
        }
    }

    // Fun√ß√£o para carregar dados do Passo 2 (CORRIGIDA)
    function loadPasso2Data(session) {
        try {
            const passo2Data = session.passo2;

            // Restaurar proposta_id
            if (passo2Data.proposta_id) {
                propostaId = passo2Data.proposta_id;
            }

            // ‚úÖ CORRE√á√ÉO: Restaurar lotes com verifica√ß√£o
            if (passo2Data.lotes && Array.isArray(passo2Data.lotes) && passo2Data.lotes.length > 0) {
                console.log('üì¶ Recuperando lotes:', passo2Data.lotes.length);

                passo2Data.lotes.forEach((loteData, index) => {
                    console.log(`üì¶ Recuperando lote ${index + 1}:`, loteData);
                    adicionarLoteRecuperado(loteData);
                });
            } else {
                console.log('‚ÑπÔ∏è Nenhum lote encontrado para recuperar');
            }

            // Restaurar despesas
            if (passo2Data.despesas && Array.isArray(passo2Data.despesas) && passo2Data.despesas.length > 0) {
                console.log('üí∞ Recuperando despesas:', passo2Data.despesas.length);

                passo2Data.despesas.forEach((despesa, index) => {
                    console.log(`üí∞ Recuperando despesa ${index + 1}:`, despesa);
                    adicionarDespesaRecuperada(despesa);
                });
            }

            // Atualizar resumos ap√≥s carregar dados
            setTimeout(() => {
                atualizarResumo();
                console.log('‚úÖ Resumo atualizado ap√≥s recupera√ß√£o');
            }, 500);

            console.log('‚úÖ Dados do Passo 2 carregados com sucesso');
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados do Passo 2:', error);
        }
    }

    // Fun√ß√£o para adicionar lote recuperado (CORRIGIDA)
    function adicionarLoteRecuperado(loteData) {
        try {
            console.log('üîÑ Adicionando lote recuperado:', loteData);

            // Verificar se loteData tem a estrutura correta
            if (!loteData || !loteData.nome) {
                console.error('‚ùå Dados do lote inv√°lidos:', loteData);
                return;
            }

            // Criar div do lote usando a fun√ß√£o existente
            const loteDiv = criarLoteDiv();

            // Definir nome do lote
            const nomeLoteInput = loteDiv.querySelector(".nomeLote");
            if (nomeLoteInput) {
                nomeLoteInput.value = loteData.nome;
                console.log(`‚úÖ Nome do lote definido: ${loteData.nome}`);
            }

            // Adicionar ao container
            lotesContainer.appendChild(loteDiv);

            // Adicionar servi√ßos do lote
            if (loteData.servicos && Array.isArray(loteData.servicos) && loteData.servicos.length > 0) {
                console.log(`üîß Adicionando ${loteData.servicos.length} servi√ßos ao lote`);

                loteData.servicos.forEach((servico, index) => {
                    console.log(`üîß Adicionando servi√ßo ${index + 1}:`, servico);
                    adicionarServicoRecuperado(loteDiv, servico);
                });
            } else {
                console.log('‚ÑπÔ∏è Nenhum servi√ßo encontrado no lote');
            }

            console.log('‚úÖ Lote recuperado com sucesso');
        } catch (error) {
            console.error('‚ùå Erro ao adicionar lote recuperado:', error);
        }
    }

    // Fun√ß√£o para adicionar servi√ßo recuperado (CORRIGIDA)
    function adicionarServicoRecuperado(loteDiv, servico) {
        try {
            console.log('üîß Adicionando servi√ßo recuperado:', servico);

            // Verificar se servico tem a estrutura correta
            if (!servico || !servico.nome) {
                console.error('‚ùå Dados do servi√ßo inv√°lidos:', servico);
                return;
            }

            const servicosContainer = loteDiv.querySelector(".servicosContainer");
            if (!servicosContainer) {
                console.error('‚ùå Container de servi√ßos n√£o encontrado');
                return;
            }

            const novaLinha = document.createElement("tr");

            novaLinha.innerHTML = `
                <td><input type="text" class="form-control nomeServico" value="${servico.nome || ''}"></td>
                <td><input type="text" class="form-control unidade" value="${servico.unidade_medida || ''}"></td>
                <td><input type="number" step="0.01" class="form-control quantidade" value="${servico.quantidade || 0}"></td>
                <td><input type="number" step="0.01" class="form-control custoUnitario" value="${servico.custo_unitario || 0}"></td>
                <td><input type="text" class="form-control valorTotal" readonly></td>
                <td><input type="number" step="0.01" class="form-control valorUnitarioVenda" value="${servico.valor_venda || 0}"></td>
                <td><input type="text" class="form-control valorTotalVenda" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm removerServico">
                    <i class="fas fa-trash"></i>
                </button></td>
            `;

            servicosContainer.appendChild(novaLinha);

            // Configurar eventos da linha
            configurarEventosServico(novaLinha);

            // Atualizar c√°lculos da linha
            atualizarLinhaServico(novaLinha);

            console.log('‚úÖ Servi√ßo recuperado com sucesso');
        } catch (error) {
            console.error('‚ùå Erro ao adicionar servi√ßo recuperado:', error);
        }
    }

    // Fun√ß√£o para adicionar despesa recuperada
    function adicionarDespesaRecuperada(despesa) {
        const novaLinha = document.createElement("tr");
        novaLinha.innerHTML = `
            <td>${despesa.nome}</td>
            <td>${despesa.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
            <td>
                <button type="button" class="btn btn-danger btn-sm removerDespesa">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        novaLinha.querySelector(".removerDespesa").addEventListener("click", () => {
            novaLinha.remove();
            atualizarResumo();
            savePasso2Data();
        });

        tabelaDespesas.appendChild(novaLinha);
    }

    // Fun√ß√£o para mostrar modal de recupera√ß√£o
    function showRecoveryModal() {
        const modal = new bootstrap.Modal(document.getElementById('recoveryModal'), {
            backdrop: 'static',
            keyboard: false
        });
        modal.show();

        // Event listeners para os bot√µes
        document.getElementById('continuarSessao').addEventListener('click', function() {
            modal.hide();
            recoverSession();
        });

        document.getElementById('novaSessao').addEventListener('click', function() {
            modal.hide();
            clearSession().then(() => {
                initCalculadora();
            }).catch(error => {
                console.error('‚ùå Erro ao limpar sess√£o:', error);
                initCalculadora(); // Continuar mesmo com erro
            });
        });
    }

    // Fun√ß√£o para recuperar sess√£o
    async function recoverSession() {
        try {
            const session = await loadSession();
            if (!session) {
                initCalculadora();
                return;
            }

            // Carregar dados do Passo 1
            loadPasso1Data(session);

            // Se estava no Passo 2, avan√ßar automaticamente
            if (session.passo_atual === 2) {
                document.getElementById("passo1").style.display = "none";
                document.getElementById("passo2").style.display = "block";

                // Carregar imposto e dados do Passo 2
                await carregarImposto();
                loadPasso2Data(session);
            }

            // Configurar salvamento autom√°tico
            setupAutoSave();
        } catch (error) {
            console.error('‚ùå Erro ao recuperar sess√£o:', error);
            alert('Erro ao recuperar sess√£o. Iniciando nova precifica√ß√£o.');
            initCalculadora();
        }
    }

    // Fun√ß√£o para inicializar calculadora normalmente
    function initCalculadora() {
        // Configurar salvamento autom√°tico
        setupAutoSave();
    }

    // Fun√ß√£o para configurar salvamento autom√°tico
    function setupAutoSave() {
        // Salvamento autom√°tico no Passo 1
        const passo1Inputs = document.querySelectorAll('#formPasso1 input, #formPasso1 textarea');
        passo1Inputs.forEach(input => {
            input.addEventListener('input', debounce(savePasso1Data, 3000));
        });

        // Salvamento autom√°tico no Passo 2 (ser√° configurado quando necess√°rio)
        if (document.getElementById('passo2').style.display !== 'none') {
            setupPasso2AutoSave();
        }
    }

    // Fun√ß√£o para configurar salvamento autom√°tico do Passo 2
    function setupPasso2AutoSave() {
        // Observar mudan√ßas no container de lotes
        const observer = new MutationObserver(debounce(savePasso2Data, 3000));
        observer.observe(lotesContainer, { childList: true, subtree: true });

        // Observar mudan√ßas na tabela de despesas
        const despesasObserver = new MutationObserver(debounce(savePasso2Data, 3000));
        despesasObserver.observe(tabelaDespesas, { childList: true, subtree: true });
    }
    // Fun√ß√£o para alterar status
async function alterarStatus(propostaId, novoStatus) {
    try {
        const response = await fetch(`/precificaja/servicos/alterar-status/${propostaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: novoStatus })
        });

        const result = await response.json();

        if (response.ok) {
            showToast('Status alterado com sucesso!', 'success');
            location.reload();
        } else {
            showToast(result.error || 'Erro ao alterar status', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro de conex√£o', 'error');
    }
}

// Fun√ß√£o para excluir proposta
async function excluirProposta(propostaId) {
    if (!confirm('Tem certeza que deseja excluir esta proposta? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }

    try {
        const response = await fetch(`/precificaja/servicos/excluir/${propostaId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            showToast('Proposta exclu√≠da com sucesso!', 'success');
            location.reload();
        } else {
            showToast(result.error || 'Erro ao excluir proposta', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro de conex√£o', 'error');
    }
}

// Fun√ß√£o para exportar BDI
function exportarBDI(propostaId) {
    window.open(`/precificaja/servicos/exportar-bdi/${propostaId}`, '_blank');
    showToast('Gerando planilha BDI...', 'info');
}

// Fun√ß√£o para exportar custos
function exportarCustos(propostaId) {
    window.open(`/precificaja/servicos/exportar-custos/${propostaId}`, '_blank');
    showToast('Gerando planilha de custos...', 'info');
}

// Fun√ß√£o para exportar PDF
function exportarPDF(propostaId) {
    window.open(`/precificaja/proposta_servico/${propostaId}/imprimir`, '_blank');
    showToast('Gerando relat√≥rio PDF...', 'info');
}

// Corre√ß√£o do modal para evitar problemas de acessibilidade
function abrirModalStatus(propostaId) {
    const modal = document.getElementById('statusModal');
    const backdrop = document.querySelector('.modal-backdrop');

    // Remove aria-hidden quando modal est√° aberto
    modal.removeAttribute('aria-hidden');
    modal.style.display = 'block';
    modal.classList.add('show');

    // Adiciona backdrop se n√£o existir
    if (!backdrop) {
        const newBackdrop = document.createElement('div');
        newBackdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(newBackdrop);
    }

    // Foca no primeiro elemento do modal
    setTimeout(() => {
        const firstInput = modal.querySelector('input, select, button');
        if (firstInput) firstInput.focus();
    }, 100);

    // Armazena ID da proposta
    modal.dataset.propostaId = propostaId;
}

// Fun√ß√£o para fechar modal corretamente
function fecharModal(modalId) {
    const modal = document.getElementById(modalId);
    const backdrop = document.querySelector('.modal-backdrop');

    modal.style.display = 'none';
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');

    if (backdrop) {
        backdrop.remove();
    }
}

// Toast melhorado
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    setTimeout(() => {
        toast.remove();
    }, 5000);
}

    // Fun√ß√£o para carregar imposto
    async function carregarImposto() {
        try {
            const response = await fetch(`${basePath}/servicos/imposto`);
            if (response.ok) {
                const data = await response.json();
                impostoVenda = data.imposto_venda || 0;
                console.log(`‚úÖ Imposto carregado: ${impostoVenda}%`);
            } else {
                console.warn('‚ö†Ô∏è Erro ao carregar imposto, usando valor padr√£o');
                impostoVenda = 10; // Valor padr√£o
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar imposto:', error);
            impostoVenda = 10; // Valor padr√£o
        }
    }

    // Fun√ß√£o para consultar CNPJ
    async function consultarCNPJ() {
        const cnpj = document.getElementById("cnpj").value.replace(/\D/g, "");

        if (cnpj.length !== 14) {
            alert("CNPJ deve ter 14 d√≠gitos.");
            return;
        }

        try {
            consultarCNPJButton.disabled = true;
            consultarCNPJButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultando...';

            const response = await fetch(`${basePath}/servicos/consultar_cnpj?cnpj=${cnpj}`);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Erro ao consultar o CNPJ.");
            }

            const data = await response.json();
            document.getElementById("razao_social").value = data.razao_social || "N√£o dispon√≠vel";
            document.getElementById("endereco").value = data.endereco || "N√£o dispon√≠vel";

            // Toast de sucesso
            const toast = document.createElement('div');
            toast.className = 'toast show position-fixed bottom-0 end-0 m-3';
            toast.innerHTML = `
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check me-2"></i>
                    <strong class="me-auto">Sucesso</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    CNPJ consultado com sucesso!
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);

        } catch (error) {
            console.error("Erro ao consultar o CNPJ:", error);
            alert(error.message || "Erro ao consultar o CNPJ.");
        } finally {
            consultarCNPJButton.disabled = false;
            consultarCNPJButton.innerHTML = '<i class="fas fa-search"></i> Consultar';
        }
    }

    // ‚úÖ FUN√á√ÉO SALVAR PASSO 1 CORRIGIDA COM VERIFICA√á√ÉO DE AUTENTICA√á√ÉO
    async function salvarPasso1() {
        const formData = new FormData(document.getElementById("formPasso1"));
        const data = Object.fromEntries(formData.entries());

        try {
            // ‚úÖ VERIFICAR SE AINDA EST√Å LOGADO
            const isAuthenticated = await verificarAutenticacao();
            if (!isAuthenticated) {
                alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                window.location.href = '/login';
                return;
            }

            salvarPasso1Button.disabled = true;
            salvarPasso1Button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            const response = await fetch(`${basePath}/servicos/passo1/salvar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            // ‚úÖ VERIFICAR SE A RESPOSTA √â JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Resposta n√£o √© JSON - poss√≠vel redirecionamento para login');
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Erro ao salvar o Passo 1.");
            }

            const result = await response.json();
            propostaId = result.proposta_id;

            // Toast de sucesso
            const toast = document.createElement('div');
            toast.className = 'toast show position-fixed bottom-0 end-0 m-3';
            toast.innerHTML = `
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check me-2"></i>
                    <strong class="me-auto">Sucesso</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${result.message || "Passo 1 salvo com sucesso!"}
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);

            document.getElementById("passo1").style.display = "none";
            document.getElementById("passo2").style.display = "block";
            await carregarImposto();

            // ‚úÖ CONFIGURAR SALVAMENTO AUTOM√ÅTICO PARA PASSO 2
            setupPasso2AutoSave();

        } catch (error) {
            console.error("Erro ao salvar o Passo 1:", error);

            // ‚úÖ TRATAMENTO ESPEC√çFICO PARA ERRO DE SESS√ÉO
            if (error.message.includes('login') || error.message.includes('JSON')) {
                alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                window.location.href = '/login';
            } else {
                alert(error.message || "Erro ao salvar os dados.");
            }
        } finally {
            salvarPasso1Button.disabled = false;
            salvarPasso1Button.innerHTML = '<i class="fas fa-arrow-right"></i> Salvar e Avan√ßar';
        }
    }

    // Fun√ß√£o para criar div de lote
    function criarLoteDiv() {
        contadorLotes++;
        const loteDiv = document.createElement("div");
        loteDiv.classList.add("lote", "card", "mb-4");

        loteDiv.innerHTML = `
            <div class="card-header bg-secondary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-layer-group"></i>
                        Lote ${contadorLotes}
                    </h4>
                    <button type="button" class="btn btn-danger btn-sm removerLote">
                        <i class="fas fa-trash"></i>
                        Remover Lote
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Nome do Lote
                    </label>
                    <input type="text" class="form-control nomeLote" placeholder="Ex: Lote 1 - Servi√ßos de Limpeza">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-secondary">
                            <tr>
                                <th><i class="fas fa-cog"></i> Nome do Servi√ßo</th>
                                <th><i class="fas fa-ruler"></i> Unidade</th>
                                <th><i class="fas fa-hashtag"></i> Quantidade</th>
                                <th><i class="fas fa-dollar-sign"></i> Custo Unit. (R$)</th>
                                <th><i class="fas fa-calculator"></i> Custo Total (R$)</th>
                                <th><i class="fas fa-tag"></i> Venda Unit. (R$)</th>
                                <th><i class="fas fa-chart-line"></i> Venda Total (R$)</th>
                                <th><i class="fas fa-tools"></i> A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="servicosContainer"></tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="4" class="text-end fw-bold">Total do Lote:</td>
                                <td class="text-end fw-bold totalCustoLote">R$ 0,00</td>
                                <td></td>
                                <td class="text-end fw-bold totalVendaLote">R$ 0,00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <button type="button" class="btn btn-success adicionarServico">
                    <i class="fas fa-plus"></i>
                    Adicionar Servi√ßo
                </button>
            </div>
        `;

        // Event listeners
        loteDiv.querySelector(".removerLote").addEventListener("click", () => {
            loteDiv.remove();
            atualizarResumo();
            savePasso2Data();
        });

        loteDiv.querySelector(".adicionarServico").addEventListener("click", () => {
            adicionarServico(loteDiv);
        });

        loteDiv.querySelector(".nomeLote").addEventListener("input", debounce(savePasso2Data, 3000));

        return loteDiv;
    }

    // Fun√ß√£o para adicionar um novo lote
    function adicionarLote() {
        const loteDiv = criarLoteDiv();
        lotesContainer.appendChild(loteDiv);
        savePasso2Data();
    }

    // Fun√ß√£o para adicionar servi√ßo
    function adicionarServico(loteDiv) {
        const servicosContainer = loteDiv.querySelector(".servicosContainer");
        const novaLinha = document.createElement("tr");

        novaLinha.innerHTML = `
            <td><input type="text" class="form-control nomeServico" placeholder="Ex: Limpeza de escrit√≥rio"></td>
            <td><input type="text" class="form-control unidade" placeholder="Ex: m¬≤, h, un"></td>
            <td><input type="number" step="0.01" class="form-control quantidade" placeholder="1"></td>
            <td><input type="number" step="0.01" class="form-control custoUnitario" placeholder="0,00"></td>
            <td><input type="text" class="form-control valorTotal" readonly></td>
            <td><input type="number" step="0.01" class="form-control valorUnitarioVenda" placeholder="0,00"></td>
            <td><input type="text" class="form-control valorTotalVenda" readonly></td>
            <td>
                <button type="button" class="btn btn-danger btn-sm removerServico">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        servicosContainer.appendChild(novaLinha);
        configurarEventosServico(novaLinha);
        savePasso2Data();
    }

    // Fun√ß√£o para configurar eventos de um servi√ßo
    function configurarEventosServico(linha) {
        const inputs = linha.querySelectorAll('input[type="number"], input[type="text"]:not([readonly])');

        inputs.forEach(input => {
            input.addEventListener("input", () => {
                atualizarLinhaServico(linha);
                atualizarResumo();
                debounce(savePasso2Data, 3000)();
            });
        });

        linha.querySelector(".removerServico").addEventListener("click", () => {
            linha.remove();
            atualizarResumo();
            savePasso2Data();
        });
    }

    // Fun√ß√£o para atualizar linha de servi√ßo
    function atualizarLinhaServico(linha) {
        const quantidade = parseFloat(linha.querySelector(".quantidade").value || 0);
        const custoUnitario = parseFloat(linha.querySelector(".custoUnitario").value || 0);
        const valorUnitarioVenda = parseFloat(linha.querySelector(".valorUnitarioVenda").value || 0);

        const total = quantidade * custoUnitario;
        const totalVenda = quantidade * valorUnitarioVenda;

        linha.querySelector(".valorTotal").value = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        linha.querySelector(".valorTotalVenda").value = totalVenda.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Atualizar total do lote
        const loteDiv = linha.closest('.lote');
        atualizarTotalLote(loteDiv);
    }

    // Fun√ß√£o para atualizar total do lote
    function atualizarTotalLote(loteDiv) {
        let totalCusto = 0;
        let totalVenda = 0;

        loteDiv.querySelectorAll(".servicosContainer tr").forEach((linha) => {
            const quantidade = parseFloat(linha.querySelector(".quantidade").value || 0);
            const custoUnitario = parseFloat(linha.querySelector(".custoUnitario").value || 0);
            const valorUnitarioVenda = parseFloat(linha.querySelector(".valorUnitarioVenda").value || 0);

            totalCusto += quantidade * custoUnitario;
            totalVenda += quantidade * valorUnitarioVenda;
        });

        loteDiv.querySelector(".totalCustoLote").textContent = totalCusto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        loteDiv.querySelector(".totalVendaLote").textContent = totalVenda.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // Fun√ß√£o para adicionar despesa
    function adicionarDespesa() {
        const nomeDespesa = document.getElementById("nomeDespesa").value.trim();
        const valorDespesa = parseFloat(document.getElementById("valorDespesa").value || 0);

        if (!nomeDespesa || valorDespesa <= 0) {
            alert("Por favor, preencha o nome e valor da despesa.");
            return;
        }

        const novaLinha = document.createElement("tr");
        novaLinha.innerHTML = `
            <td>${nomeDespesa}</td>
            <td>${valorDespesa.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
            <td>
                <button type="button" class="btn btn-danger btn-sm removerDespesa">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        novaLinha.querySelector(".removerDespesa").addEventListener("click", () => {
            novaLinha.remove();
            atualizarResumo();
            savePasso2Data();
        });

        tabelaDespesas.appendChild(novaLinha);

        // Limpar campos
        document.getElementById("nomeDespesa").value = "";
        document.getElementById("valorDespesa").value = "";

        atualizarResumo();
        savePasso2Data();
    }

    // Fun√ß√£o para atualizar resumo
    function atualizarResumo() {
        let custoTotal = 0;
        let vendaTotal = 0;
        let totalDespesas = 0;

        // Calcular totais dos lotes
        lotesContainer.querySelectorAll(".lote").forEach((loteDiv) => {
            loteDiv.querySelectorAll(".servicosContainer tr").forEach((linha) => {
                const quantidade = parseFloat(linha.querySelector(".quantidade").value || 0);
                const custoUnitario = parseFloat(linha.querySelector(".custoUnitario").value || 0);
                const valorUnitarioVenda = parseFloat(linha.querySelector(".valorUnitarioVenda").value || 0);

                custoTotal += quantidade * custoUnitario;
                vendaTotal += quantidade * valorUnitarioVenda;
            });
        });

        // Calcular total de despesas
        tabelaDespesas.querySelectorAll("tr").forEach((linha) => {
            if (linha.children.length >= 2) {
                const valor = parseFloat(linha.children[1].textContent.replace(/[^\d,-]+/g, "").replace(",", ".")) || 0;
                totalDespesas += valor;
            }
        });

        const impostoTotal = vendaTotal * (impostoVenda / 100);
        const lucroTotal = vendaTotal - custoTotal - totalDespesas - impostoTotal;
        const margemLucro = vendaTotal > 0 ? ((lucroTotal / vendaTotal) * 100) : 0;

        // Atualizar elementos do resumo
        resumoCustoTotal.textContent = custoTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        resumoImpostoTotal.textContent = impostoTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        resumoValorVendaTotal.textContent = vendaTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        resumoLucroTotal.textContent = lucroTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        resumoMargemLucro.textContent = margemLucro.toFixed(2) + '%';
        totalDespesasElem.textContent = totalDespesas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // Colorir lucro baseado no valor
        if (lucroTotal > 0) {
            resumoLucroTotal.className = 'text-end fw-bold fs-5 text-success';
        } else if (lucroTotal < 0) {
            resumoLucroTotal.className = 'text-end fw-bold fs-5 text-danger';
        } else {
            resumoLucroTotal.className = 'text-end fw-bold fs-5 text-muted';
        }
    }

    // Fun√ß√£o para finalizar precifica√ß√£o (modificada para limpar sess√£o)
    async function finalizarPrecificacao() {
        const lotes = [];
        lotesContainer.querySelectorAll(".lote").forEach((loteDiv) => {
            const nomeLote = loteDiv.querySelector(".nomeLote").value.trim();
            const servicos = [];

            loteDiv.querySelectorAll(".servicosContainer tr").forEach((linha) => {
                servicos.push({
                    nome: linha.querySelector(".nomeServico").value.trim(),
                    unidade_medida: linha.querySelector(".unidade").value.trim(),
                    quantidade: parseFloat(linha.querySelector(".quantidade").value.replace(',', '.')) || 0,
                    custo_unitario: parseFloat(linha.querySelector(".custoUnitario").value.replace(',', '.')) || 0,
                    valor_venda: parseFloat(linha.querySelector(".valorUnitarioVenda").value.replace(',', '.')) || 0,
                });
            });

            if (nomeLote) {
                lotes.push({ nome: nomeLote, servicos });
            }
        });

        const despesas = [];
        tabelaDespesas.querySelectorAll("tr").forEach((linha) => {
            if (linha.children.length >= 2) {
                despesas.push({
                    nome: linha.children[0].textContent.trim(),
                    valor: parseFloat(linha.children[1].textContent.replace(/[^\d,-]+/g, "").replace(",", ".")) || 0,
                });
            }
        });

        if (lotes.length === 0) {
            alert("Adicione pelo menos um lote com servi√ßos antes de finalizar.");
            return;
        }

        try {
            finalizarButton.disabled = true;
            finalizarButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalizando...';

            const response = await fetch(`${basePath}/servicos/passo2/salvar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    proposta_id: propostaId,
                    lotes: lotes,
                    despesas: despesas,
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Erro ao finalizar precifica√ß√£o.");
            }

            const result = await response.json();

            // ‚úÖ LIMPAR SESS√ÉO AP√ìS FINALIZAR
            await clearSession();

            // Toast de sucesso
            const toast = document.createElement('div');
            toast.className = 'toast show position-fixed bottom-0 end-0 m-3';
            toast.innerHTML = `
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check me-2"></i>
                    <strong class="me-auto">Sucesso</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${result.message || "Precifica√ß√£o finalizada com sucesso!"}
                </div>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                window.location.href = "/precificaja/calculadora_servicos";
            }, 2000);

        } catch (error) {
            console.error("Erro ao finalizar precifica√ß√£o:", error);
            alert(error.message || "Erro ao finalizar precifica√ß√£o.");
        } finally {
            finalizarButton.disabled = false;
            finalizarButton.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Precifica√ß√£o';
        }
    }
(function() {
    'use strict';

    let dadosEdital = null;
    let observerPasso2 = null;

    console.log('üîß Script FINAL servi√ßos carregado (v1.0)');

    function verificarOrigem() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('source') === 'edital';
    }

    async function buscarDadosEdital() {
        try {
            console.log('üì• Buscando dados do edital...');
            const response = await fetch('/precificaja/api/get_edital_data');
            const result = await response.json();

            if (result.success && result.data) {
                console.log('‚úÖ Dados recebidos:', result.data);
                dadosEdital = result.data;
                return result.data;
            }
            return null;
        } catch (error) {
            console.error('‚ùå Erro:', error);
            return null;
        }
    }

    function mostrarNotificacao(mensagem, tipo = 'info') {
        const cores = {
            'success': 'alert-success',
            'info': 'alert-info',
            'warning': 'alert-warning',
            'error': 'alert-danger'
        };

        const icones = {
            'success': 'fa-check-circle',
            'info': 'fa-info-circle',
            'warning': 'fa-exclamation-triangle',
            'error': 'fa-times-circle'
        };

        const toast = document.createElement('div');
        toast.className = `alert ${cores[tipo]} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        toast.innerHTML = `
            <i class="fas ${icones[tipo]} me-2"></i>
            <strong>${mensagem}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function preencherCampo(seletor, valor) {
        const campo = document.querySelector(seletor);
        if (campo && valor) {
            campo.value = valor;
            campo.dispatchEvent(new Event('input', { bubbles: true }));
            campo.dispatchEvent(new Event('change', { bubbles: true }));
            return true;
        }
        return false;
    }

    function verificarCamposObrigatorios() {
        const campos = ['#cnpj', '#razao_social', '#endereco', '#numero_processo', '#validade_proposta', '#prazo_pagamento', '#prazo_entrega'];

        for (const seletor of campos) {
            const campo = document.querySelector(seletor);
            if (!campo || !campo.value || campo.value.trim() === '') {
                console.log(`‚ö†Ô∏è  Campo vazio: ${seletor}`);
                return false;
            }
        }
        return true;
    }

    function preencherPasso1(dados) {
        const info = dados.informacoes_gerais || {};
        let preenchidos = 0;

        console.log('üìù Preenchendo Passo 1...');

        if (info.cnpj && preencherCampo('#cnpj', info.cnpj)) {
            console.log('  ‚úì CNPJ:', info.cnpj);
            preenchidos++;
        }

        if (info.razao_social && preencherCampo('#razao_social', info.razao_social)) {
            console.log('  ‚úì Raz√£o Social');
            preenchidos++;
        }

        if (info.endereco && preencherCampo('#endereco', info.endereco)) {
            console.log('  ‚úì Endere√ßo');
            preenchidos++;
        }

        if (info.numero_processo && preencherCampo('#numero_processo', info.numero_processo)) {
            console.log('  ‚úì N¬∫ Processo');
            preenchidos++;
        }

        if (info.validade_proposta && preencherCampo('#validade_proposta', info.validade_proposta)) {
            console.log('  ‚úì Validade:', info.validade_proposta);
            preenchidos++;
        }

        if (info.prazo_pagamento && preencherCampo('#prazo_pagamento', info.prazo_pagamento)) {
            console.log('  ‚úì Prazo Pagamento:', info.prazo_pagamento);
            preenchidos++;
        }

        if (info.prazo_entrega && preencherCampo('#prazo_entrega', info.prazo_entrega)) {
            console.log('  ‚úì Prazo Entrega:', info.prazo_entrega);
            preenchidos++;
        }

        console.log(`‚úÖ ${preenchidos}/7 campos preenchidos`);

        const completo = verificarCamposObrigatorios();

        if (completo) {
            mostrarNotificacao('Dados importados! Avan√ßando...', 'success');
            return true;
        } else {
            mostrarNotificacao('Dados parciais. Complete os campos.', 'warning');
            return false;
        }
    }

    function isPasso2Visivel() {
        const passo2 = document.getElementById('passo2');
        if (passo2) {
            const estilo = window.getComputedStyle(passo2);
            return estilo.display !== 'none';
        }
        return false;
    }

    function monitorarPasso2() {
        console.log('üëÄ Monitorando Passo 2...');

        if (isPasso2Visivel()) {
            console.log('‚úÖ Passo 2 j√° est√° vis√≠vel!');
            setTimeout(() => preencherPasso2(dadosEdital), 500);
            return;
        }

        observerPasso2 = new MutationObserver(() => {
            if (isPasso2Visivel()) {
                console.log('‚úÖ Passo 2 detectado!');
                observerPasso2.disconnect();
                setTimeout(() => preencherPasso2(dadosEdital), 500);
            }
        });

        observerPasso2.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });

        console.log('‚úÖ Observer ativado');
    }

    async function preencherPasso2(dados) {
        const itens = dados.itens || [];

        if (itens.length === 0) {
            console.warn('‚ö†Ô∏è  Nenhum item para preencher');
            return;
        }

        console.log(`üìù Iniciando preenchimento de servi√ßos...`);
        console.log(`   Total de itens: ${itens.length}`);

        mostrarNotificacao(`Criando Lote 1 com ${itens.length} servi√ßos...`, 'info');

        // 1. Primeiro cria o Lote 1
        await criarLote();

        // 2. Depois adiciona todos os servi√ßos
        await adicionarServicosSequencialmente(itens, 0);
    }

    /**
     * Cria o Lote 1
     */
    function criarLote() {
        return new Promise((resolve, reject) => {
            console.log('\nüì¶ Criando Lote 1...');

            // Procura o bot√£o de adicionar lote
            const botaoLote = document.querySelector('.adicionarLote');

            if (!botaoLote) {
                console.error('‚ùå Bot√£o .adicionarLote n√£o encontrado!');
                reject('Bot√£o n√£o encontrado');
                return;
            }

            console.log('‚úì Clicando em .adicionarLote...');
            botaoLote.click();

            // Aguarda o lote ser criado
            setTimeout(() => {
                const lote = document.querySelector('.lote');

                if (!lote) {
                    console.error('‚ùå Lote n√£o foi criado!');
                    reject('Lote n√£o criado');
                    return;
                }

                // Preenche o nome do lote
                const inputNomeLote = lote.querySelector('.nomeLote');
                if (inputNomeLote) {
                    inputNomeLote.value = 'Lote 1';
                    inputNomeLote.dispatchEvent(new Event('input', { bubbles: true }));
                    inputNomeLote.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('‚úÖ Lote 1 criado e nomeado');
                } else {
                    console.warn('‚ö†Ô∏è  Campo .nomeLote n√£o encontrado');
                }

                resolve(lote);
            }, 800);
        });
    }

    /**
     * Adiciona servi√ßos um por vez
     */
    async function adicionarServicosSequencialmente(itens, index) {
        if (index >= itens.length) {
            console.log('‚úÖ Todos os servi√ßos foram adicionados!');
            mostrarNotificacao(`${itens.length} servi√ßos adicionados!`, 'success');
            return;
        }

        const item = itens[index];
        const numero = index + 1;

        console.log(`\nüîπ Servi√ßo ${numero}/${itens.length}:`);
        console.log(`   Nome: ${item.descricao.substring(0, 50)}...`);
        console.log(`   Quantidade: ${item.quantidade}`);
        console.log(`   Unidade: ${item.unidade}`);
        console.log(`   Custo: ${item.valor_unitario}`);

        try {
            await adicionarEPreencherServico(item, numero);
            await sleep(1000);
            adicionarServicosSequencialmente(itens, index + 1);
        } catch (error) {
            console.error(`   ‚ùå Erro ao adicionar servi√ßo ${numero}:`, error);
            await sleep(1000);
            adicionarServicosSequencialmente(itens, index + 1);
        }
    }

    /**
     * Adiciona e preenche um √∫nico servi√ßo
     */
    function adicionarEPreencherServico(item, numero) {
        return new Promise((resolve, reject) => {
            // Pega o lote
            const lote = document.querySelector('.lote');
            if (!lote) {
                console.error('   ‚ùå Lote n√£o encontrado!');
                reject('Lote n√£o encontrado');
                return;
            }

            // Pega o container de servi√ßos
            const servicosContainer = lote.querySelector('.servicosContainer');
            if (!servicosContainer) {
                console.error('   ‚ùå Container .servicosContainer n√£o encontrado!');
                reject('Container n√£o encontrado');
                return;
            }

            // Conta quantas linhas existem ANTES
            const linhasAntes = servicosContainer.querySelectorAll('tr').length;
            console.log(`   üìä Linhas antes: ${linhasAntes}`);

            // Procura o bot√£o de adicionar servi√ßo
            const botaoServico = lote.querySelector('.adicionarServico');
            if (!botaoServico) {
                console.error('   ‚ùå Bot√£o .adicionarServico n√£o encontrado!');
                reject('Bot√£o n√£o encontrado');
                return;
            }

            console.log('   ‚úì Clicando em .adicionarServico...');
            botaoServico.click();

            // Aguarda a nova linha aparecer
            let tentativas = 0;
            const maxTentativas = 30;

            const intervalo = setInterval(() => {
                tentativas++;

                const linhasDepois = servicosContainer.querySelectorAll('tr').length;

                if (linhasDepois > linhasAntes) {
                    clearInterval(intervalo);
                    console.log(`   ‚úÖ Nova linha criada! (${linhasDepois} linhas total)`);

                    // Pega a √∫ltima linha
                    const linhas = servicosContainer.querySelectorAll('tr');
                    const ultimaLinha = linhas[linhas.length - 1];

                    // Aguarda os campos estarem prontos
                    setTimeout(() => {
                        const sucesso = preencherCamposServico(ultimaLinha, item, numero);
                        if (sucesso) {
                            resolve();
                        } else {
                            reject('Falha ao preencher');
                        }
                    }, 500);

                } else if (tentativas >= maxTentativas) {
                    clearInterval(intervalo);
                    console.error(`   ‚ùå Timeout: Nova linha n√£o foi criada`);
                    reject('Timeout');
                }
            }, 200);
        });
    }

    /**
     * Preenche os campos do servi√ßo
     */
    function preencherCamposServico(linha, item, numero) {
        console.log(`   üìù Preenchendo campos...`);

        let preenchidos = 0;

        // Nome do Servi√ßo - .nomeServico
        const campoNome = linha.querySelector('.nomeServico');
        if (campoNome && item.descricao) {
            campoNome.value = item.descricao;
            campoNome.dispatchEvent(new Event('input', { bubbles: true }));
            campoNome.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('   ‚úì Nome preenchido');
            preenchidos++;
        } else {
            console.error('   ‚ùå Campo .nomeServico n√£o encontrado');
        }

        // Unidade - .unidade
        const campoUnidade = linha.querySelector('.unidade');
        if (campoUnidade && item.unidade) {
            campoUnidade.value = item.unidade.toUpperCase();
            campoUnidade.dispatchEvent(new Event('input', { bubbles: true }));
            campoUnidade.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`   ‚úì Unidade preenchida: ${item.unidade}`);
            preenchidos++;
        } else {
            console.error('   ‚ùå Campo .unidade n√£o encontrado');
        }

        // Quantidade - .quantidade
        const campoQtd = linha.querySelector('.quantidade');
        if (campoQtd && item.quantidade) {
            let qtd = item.quantidade.toString().replace(/[^\d.,]/g, '').replace(',', '.');
            campoQtd.value = qtd;
            campoQtd.dispatchEvent(new Event('input', { bubbles: true }));
            campoQtd.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`   ‚úì Quantidade preenchida: ${qtd}`);
            preenchidos++;
        } else {
            console.error('   ‚ùå Campo .quantidade n√£o encontrado');
        }

        // Custo Unit√°rio - .custoUnitario
        const campoCusto = linha.querySelector('.custoUnitario');
        if (campoCusto && item.valor_unitario) {
            let valor = item.valor_unitario.toString();
            valor = valor.replace(/R\$\s*/g, '');
            valor = valor.replace(/[^\d.,]/g, '');
            valor = valor.replace(',', '.');

            campoCusto.value = valor;
            campoCusto.dispatchEvent(new Event('input', { bubbles: true }));
            campoCusto.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`   ‚úì Custo preenchido: ${valor}`);
            preenchidos++;
        } else {
            console.error('   ‚ùå Campo .custoUnitario n√£o encontrado');
        }

        console.log(`   ‚úÖ Servi√ßo ${numero}: ${preenchidos}/4 campos preenchidos\n`);

        return preenchidos === 4;
    }

    /**
     * Fun√ß√£o auxiliar para aguardar
     */
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function avancarParaPasso2() {
        console.log('‚è≠Ô∏è  Tentando avan√ßar para Passo 2...');

        const botao = document.getElementById('btnSalvarPasso1');

        if (botao) {
            setTimeout(() => {
                botao.click();
                console.log('‚úÖ Bot√£o #btnSalvarPasso1 clicado');
                monitorarPasso2();
            }, 800);
        } else {
            console.warn('‚ö†Ô∏è  Bot√£o #btnSalvarPasso1 n√£o encontrado');
            monitorarPasso2();
        }
    }

    async function inicializar() {
        if (!verificarOrigem()) {
            console.log('‚ÑπÔ∏è  N√£o veio do leitor de editais');
            return;
        }

        console.log('üöÄ Iniciando preenchimento autom√°tico de SERVI√áOS (v1.0)...');

        const dados = await buscarDadosEdital();
        if (!dados) {
            mostrarNotificacao('Erro ao carregar dados', 'error');
            return;
        }

        const completo = preencherPasso1(dados);

        if (completo) {
            avancarParaPasso2();
        } else {
            monitorarPasso2();
        }

        const url = new URL(window.location);
        url.searchParams.delete('source');
        window.history.replaceState({}, '', url);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        inicializar();
    }

})();

    // Event listeners
    consultarCNPJButton.addEventListener("click", consultarCNPJ);
    salvarPasso1Button.addEventListener("click", salvarPasso1);
    adicionarLoteButton.addEventListener("click", adicionarLote);
    adicionarDespesaButton.addEventListener("click", adicionarDespesa);
    finalizarButton.addEventListener("click", finalizarPrecificacao);

    // ===== INICIALIZA√á√ÉO =====
    checkExistingSession();
});
</script>

{% endblock %}

