{% extends "base.html" %}

{% block title %}Calculadora de Produtos - Passos 1 e 2{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header com Gradiente -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-2">
                                <i class="fas fa-calculator me-3"></i>
                                Calculadora de Produtos
                            </h1>
                            <p class="mb-0 opacity-75">
                                Gerencie e calcule suas propostas de produtos com ferramentas avançadas
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex align-items-center justify-content-end">
                                <span class="badge bg-light text-dark fs-6 me-3">
                                    <i class="fas fa-step-forward me-1"></i>
                                    <span id="passoAtual">Passo 1</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Passo 1 -->
    <div id="passo1" style="display: block;">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-building me-2"></i>
                    Passo 1: Dados da Empresa
                </h2>
            </div>
            <div class="card-body">
                <form id="formPasso1" class="row g-3">
                    <div class="col-12">
                        <label for="cnpj" class="form-label fw-semibold">
                            <i class="fas fa-id-card text-muted me-2"></i>
                            CNPJ
                        </label>
                        <div class="input-group">
                            <input type="text" id="cnpj" name="cnpj" class="form-control"
                                   placeholder="00.000.000/0000-00" required>
                            <button type="button" id="consultarCNPJ" class="btn btn-outline-primary">
                                <i class="fas fa-search me-1"></i>
                                Consultar
                            </button>
                        </div>
                        <div class="form-text">Digite apenas números</div>
                    </div>

                    <div class="col-12">
                        <label for="razao_social" class="form-label fw-semibold">
                            <i class="fas fa-building text-muted me-2"></i>
                            Razão Social
                        </label>
                        <input type="text" id="razao_social" name="razao_social"
                               class="form-control" readonly>
                    </div>

                    <div class="col-12">
                        <label for="endereco" class="form-label fw-semibold">
                            <i class="fas fa-map-marker-alt text-muted me-2"></i>
                            Endereço
                        </label>
                        <textarea id="endereco" name="endereco" class="form-control"
                                  rows="3" readonly></textarea>
                    </div>

                    <div class="col-md-6">
                        <label for="numero_processo" class="form-label fw-semibold">
                            <i class="fas fa-file-alt text-muted me-2"></i>
                            Número do Processo
                        </label>
                        <input type="text" id="numero_processo" name="numero_processo"
                               class="form-control" placeholder="Ex: 001/2024" required>
                    </div>

                    <div class="col-md-6">
                        <label for="validade_proposta" class="form-label fw-semibold">
                            <i class="fas fa-calendar text-muted me-2"></i>
                            Validade da Proposta (dias)
                        </label>
                        <input type="number" id="validade_proposta" name="validade_proposta"
                               class="form-control" placeholder="60" min="1" required>
                    </div>

                    <div class="col-md-6">
                        <label for="prazo_pagamento" class="form-label fw-semibold">
                            <i class="fas fa-credit-card text-muted me-2"></i>
                            Prazo de Pagamento
                        </label>
                        <input type="text" id="prazo_pagamento" name="prazo_pagamento"
                               class="form-control" placeholder="Ex: 30 dias" required>
                    </div>

                    <div class="col-md-6">
                        <label for="local_entrega" class="form-label fw-semibold">
                            <i class="fas fa-truck text-muted me-2"></i>
                            Local de Entrega
                        </label>
                        <input type="text" id="local_entrega" name="local_entrega"
                               class="form-control" placeholder="Ex: São Paulo - SP" required>
                    </div>

                    <div class="col-md-6">
                        <label for="prazo_entrega" class="form-label fw-semibold">
                            <i class="fas fa-clock text-muted me-2"></i>
                            Prazo de Entrega (dias)
                        </label>
                        <input type="number" id="prazo_entrega" name="prazo_entrega"
                               class="form-control" placeholder="30" min="1" required>
                    </div>

                    <div class="col-12">
                        <div class="d-grid">
                            <button type="button" id="salvarPasso1" class="btn btn-success btn-lg">
                                <i class="fas fa-arrow-right me-2"></i>
                                Salvar e Avançar para Produtos
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Passo 2 -->
    <div id="passo2" style="display: none;">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">
                        <i class="fas fa-boxes me-2"></i>
                        Passo 2: Cadastro de Produtos
                    </h2>
                    <button type="button" id="lancarProduto" class="btn btn-light">
                        <i class="fas fa-plus me-1"></i>
                        Adicionar Produto
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="formPasso2">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-hashtag me-1"></i>Nº</th>
                                    <th><i class="fas fa-box me-1"></i>Nome do Produto</th>
                                    <th><i class="fas fa-tag me-1"></i>Marca/Modelo</th>
                                    <th><i class="fas fa-dollar-sign me-1"></i>Custo (R$)</th>
                                    <th><i class="fas fa-sort-numeric-up me-1"></i>Qtd</th>
                                    <th><i class="fas fa-ruler me-1"></i>Unidade</th>
                                    <th><i class="fas fa-chart-line me-1"></i>Referência (R$)</th>
                                    <th><i class="fas fa-money-bill-wave me-1"></i>Venda (R$)</th>
                                    <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="produtosTableBody">
                                <!-- Produtos serão inseridos aqui dinamicamente -->
                            </tbody>
                        </table>
                    </div>

                    <div id="mensagemErro" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Por favor, preencha todos os campos obrigatórios antes de finalizar.
                    </div>
                </form>

                <!-- Resumos Individuais -->
                <div id="resumosIndividuais" class="mt-4" style="display: none;">
                    <h4 class="mb-3">
                        <i class="fas fa-list-alt me-2"></i>
                        Resumos Individuais por Item
                    </h4>
                    <div id="resumosContainer" class="row"></div>
                </div>

                <!-- Resumo Total -->
                <div class="mt-4">
                    <h4 class="mb-3">
                        <i class="fas fa-chart-pie me-2"></i>
                        Resumo Total da Proposta
                    </h4>
                    <div class="row">
                        <div class="col-lg-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-calculator me-2"></i>
                                        Custos e Despesas
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <th>Custo Total dos Produtos</th>
                                            <td class="text-end fw-bold" id="custoTotal">R$ 0,00</td>
                                        </tr>
                                        <tr>
                                            <th>Custo de Frete</th>
                                            <td class="text-end">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="text" id="custoFrete"
                                                           class="form-control text-end money-input" placeholder="0,00">
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="table-warning">
                                            <th>Imposto Total</th>
                                            <td class="text-end fw-bold" id="impostoTotal">R$ 0,00</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>
                                        Vendas e Lucro
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <th>Quantidade Total</th>
                                            <td class="text-end fw-bold" id="quantidadeTotal">0</td>
                                        </tr>
                                        <tr>
                                            <th>Referência Total</th>
                                            <td class="text-end fw-bold" id="referenciaTotal">R$ 0,00</td>
                                        </tr>
                                        <tr>
                                            <th>Valor de Venda Total</th>
                                            <td class="text-end fw-bold" id="valorVendaTotal">R$ 0,00</td>
                                        </tr>
                                        <tr class="table-success">
                                            <th><strong>Lucro Total</strong></th>
                                            <td class="text-end fw-bold text-success" id="lucroTotal">
                                                <strong>R$ 0,00</strong>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botão Finalizar -->
                    <div class="d-grid mt-4">
                        <button type="button" id="finalizarPrecificacao" class="btn btn-success btn-lg">
                            <i class="fas fa-check-circle me-2"></i>
                            Finalizar Precificação
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Recuperação de Sessão -->
<div class="modal fade" id="modalRecuperacao" tabindex="-1" aria-labelledby="modalRecuperacaoLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalRecuperacaoLabel">
                    <i class="fas fa-history me-2"></i>
                    Recuperar Sessão
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-clock text-primary" style="font-size: 3rem;"></i>
                </div>
                <h6 class="text-center mb-3">Encontramos uma precificação em andamento!</h6>
                <p class="text-muted text-center">
                    Você tem dados salvos de uma sessão anterior. Deseja continuar de onde parou ou iniciar uma nova precificação?
                </p>
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Dados encontrados:</strong> <span id="dadosEncontrados"></span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="btnNovaSession">
                    <i class="fas fa-plus me-1"></i>
                    Nova Precificação
                </button>
                <button type="button" class="btn btn-primary" id="btnContinuarSession">
                    <i class="fas fa-play me-1"></i>
                    Continuar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<style>
.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.toast {
    border-radius: 10px;
}

.alert {
    border-radius: 10px;
    border: none;
}

.badge {
    border-radius: 20px;
    padding: 8px 16px;
}

.table-responsive {
    border-radius: 10px;
    overflow: hidden;
}

.card-header {
    border-bottom: 2px solid rgba(255,255,255,0.1);
}

.fw-semibold {
    font-weight: 600;
}

.text-muted {
    opacity: 0.7;
}

.modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header {
    border-radius: 15px 15px 0 0;
}

/* Estilo para dropdown de produtos */
.produto-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 9999 !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Garantir que o datalist tenha z-index alto */
datalist {
    z-index: 99999 !important;
    position: fixed !important;
    background: white !important;
    border: 1px solid #ddd !important;
    border-radius: 5px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
    max-height: 200px !important;
    overflow-y: auto !important;
}

/* Garantir que inputs com datalist tenham posição relativa */
input[list] {
    position: relative;
    z-index: 10000 !important;
}

/* Garantir que a tabela não interfira no z-index */
.table-responsive {
    position: relative;
    z-index: 1;
    overflow: visible !important;
}

/* Garantir que os cards de resumo tenham z-index menor */
.card {
    position: relative;
    z-index: 1 !important;
}

/* Garantir que o container de resumos tenha z-index menor */
#resumosIndividuais,
.mt-4 {
    position: relative;
    z-index: 1 !important;
}

/* Forçar overflow visible em containers que podem estar cortando o dropdown */
.card-body {
    overflow: visible !important;
    position: relative;
    z-index: 1 !important;
}

.container-fluid {
    overflow: visible !important;
    position: relative;
    z-index: 1 !important;
}

/* Estilo específico para o td que contém o input com datalist */
td:has(input[list]) {
    position: relative;
    overflow: visible !important;
    z-index: 10000 !important;
}

/* Alternativa para navegadores que não suportam :has() */
.product-name-cell {
    position: relative;
    overflow: visible !important;
    z-index: 10000 !important;
}

/* Garantir que todos os elementos de texto tenham z-index menor */
h1, h2, h3, h4, h5, h6, p, span, div:not(.modal):not(.modal-dialog):not(.modal-content):not(.modal-header):not(.modal-body):not(.modal-footer) {
    position: relative;
    z-index: 1 !important;
}

/* Garantir que todos os elementos Bootstrap tenham z-index menor */
.row, .col, .col-lg-6, .col-md-6, .col-12 {
    position: relative;
    z-index: 1 !important;
}

/* Forçar z-index baixo para elementos específicos que estão sobrepondo */
.card-header {
    position: relative;
    z-index: 1 !important;
}

/* Garantir que tabelas tenham z-index baixo */
table, thead, tbody, tr, th, td {
    position: relative;
    z-index: 1 !important;
}

/* Exceção para a célula do produto */
td.product-name-cell {
    z-index: 10000 !important;
}

/* Correção específica para modal e backdrop */
.modal {
    z-index: 50000 !important;
}

.modal-backdrop {
    z-index: 49999 !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    opacity: 1 !important;
}

.modal-dialog {
    z-index: 50001 !important;
    position: relative;
}

.modal-content {
    z-index: 50002 !important;
    position: relative;
    background-color: white !important;
}

.modal-header,
.modal-body,
.modal-footer {
    z-index: 50003 !important;
    position: relative;
}

.produto-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.produto-item:hover {
    background-color: #f8f9fa;
}

.produto-item:last-child {
    border-bottom: none;
}

.produto-nome {
    font-weight: 600;
    color: #333;
}

.produto-detalhes {
    font-size: 0.85em;
    color: #666;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const basePath = ""; // Prefixo corrigido
    const produtosTableBody = document.getElementById("produtosTableBody");
    const custoFreteInput = document.getElementById("custoFrete");
    const finalizarButton = document.getElementById("finalizarPrecificacao");
    const salvarPasso1Button = document.getElementById("salvarPasso1");
    const passo1Div = document.getElementById("passo1");
    const passo2Div = document.getElementById("passo2");
    const resumosContainer = document.getElementById("resumosContainer");
    const resumosIndividuais = document.getElementById("resumosIndividuais");
    let propostaId = null;
    let impostoVenda = 0;
    let contadorItens = 0;

    // Constantes para localStorage
    const STORAGE_KEY = 'calculadora_produtos_sessao';
    const EXPIRY_HOURS = 24;

    // ===== FUNÇÕES DE FORMATAÇÃO DE MOEDA =====

    // Função para formatar valor como moeda brasileira
    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(valor);
    }

    // Função para converter moeda para número
    function moedaParaNumero(valor) {
        if (typeof valor === 'number') return valor;
        if (!valor) return 0;

        // Remove R$, espaços e pontos (milhares), substitui vírgula por ponto
        return parseFloat(valor.toString()
            .replace(/[R$\s]/g, '')
            .replace(/\./g, '')
            .replace(',', '.')) || 0;
    }

    // Função para aplicar máscara de moeda
    function aplicarMascaraMoeda(input) {
        input.addEventListener('input', function(e) {
            let valor = e.target.value;

            // Remove tudo que não é número
            valor = valor.replace(/\D/g, '');

            // Converte para centavos
            valor = (parseInt(valor) / 100).toFixed(2);

            // Aplica formatação brasileira
            valor = valor.replace('.', ',');
            valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');

            e.target.value = valor;
        });

        input.addEventListener('blur', function(e) {
            if (!e.target.value) {
                e.target.value = '0,00';
            }
        });
    }

    // ===== FUNÇÕES DE BUSCA DE PRODUTOS =====

    // Função para buscar produtos na base de dados
    async function buscarProdutos(termo) {
        try {
            const response = await fetch(`/precificaja/api/buscar_produtos?q=${termo}`, {
                method: "GET",
                credentials: "include"
            });

            if (!response.ok) {
                throw new Error(`Erro ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data || [];
        } catch (error) {
            console.error("Erro ao buscar produtos:", error);
            return [];
        }
    }

    // Função para criar dropdown de produtos
    function criarDropdownProdutos(input, produtos) {
        // Remove dropdown existente
        const dropdownExistente = input.parentNode.querySelector('.produto-dropdown');
        if (dropdownExistente) {
            dropdownExistente.remove();
        }

        if (produtos.length === 0) return;

        // Criar novo dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'produto-dropdown';

        produtos.forEach(produto => {
            const item = document.createElement('div');
            item.className = 'produto-item';
            item.innerHTML = `
                <div class="produto-nome">${produto.nome}</div>
                <div class="produto-detalhes">
                    ${produto.marca_modelo} - Custo: ${formatarMoeda(produto.custo)}
                </div>
            `;

            item.addEventListener('click', () => {
                preencherProduto(input, produto);
                dropdown.remove();
            });

            dropdown.appendChild(item);
        });

        // Posicionar dropdown
        input.parentNode.style.position = 'relative';
        input.parentNode.appendChild(dropdown);

        // Fechar dropdown ao clicar fora
        setTimeout(() => {
            document.addEventListener('click', function fecharDropdown(e) {
                if (!dropdown.contains(e.target) && e.target !== input) {
                    dropdown.remove();
                    document.removeEventListener('click', fecharDropdown);
                }
            });
        }, 100);
    }

    // Função para preencher dados do produto selecionado
    function preencherProduto(inputNome, produto) {
        const row = inputNome.closest('tr');
        const inputs = row.querySelectorAll('input');

        // Preencher campos
        inputs[1].value = produto.nome; // Nome
        inputs[2].value = produto.marca_modelo; // Marca/Modelo
        inputs[3].value = produto.custo.toFixed(2).replace('.', ','); // Custo
        inputs[5].value = produto.unidade_medida || ''; // Unidade

        // Aplicar máscara nos campos monetários
        aplicarMascaraMoeda(inputs[3]); // Custo
        if (inputs[6]) aplicarMascaraMoeda(inputs[6]); // Referência
        if (inputs[7]) aplicarMascaraMoeda(inputs[7]); // Venda

        // Recalcular e salvar
        calcularResumos();
        salvarSessao();

        mostrarToast('Sucesso', 'Produto preenchido automaticamente!', 'success');
    }

    // Função para configurar busca automática em um input
    function configurarBuscaProduto(inputNome) {
        let timeoutBusca;

        inputNome.addEventListener('input', function(e) {
            const termo = e.target.value.trim();

            // Limpar timeout anterior
            if (timeoutBusca) {
                clearTimeout(timeoutBusca);
            }

            // Remover dropdown se termo muito curto
            if (termo.length < 2) {
                const dropdown = inputNome.parentNode.querySelector('.produto-dropdown');
                if (dropdown) dropdown.remove();
                return;
            }

            // Buscar após 300ms de pausa na digitação
            timeoutBusca = setTimeout(async () => {
                const produtos = await buscarProdutos(termo);
                criarDropdownProdutos(inputNome, produtos);
            }, 300);
        });
    }

    // ===== FUNÇÕES DE RECUPERAÇÃO DE SESSÃO =====

    // Função para salvar dados no localStorage
    function salvarSessao() {
        try {
            const dadosPasso1 = {};
            const formPasso1 = document.getElementById('formPasso1');
            if (formPasso1) {
                const formData = new FormData(formPasso1);
                for (let [key, value] of formData.entries()) {
                    dadosPasso1[key] = value;
                }
            }

            const produtos = [];
            const rows = produtosTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length >= 8) {
                    produtos.push({
                        numero_item: inputs[0].value,
                        nome: inputs[1].value,
                        marca_modelo: inputs[2].value,
                        custo: inputs[3].value,
                        quantidade: inputs[4].value,
                        unidade_medida: inputs[5].value,
                        referencia: inputs[6].value,
                        venda: inputs[7].value
                    });
                }
            });

            const dadosSessao = {
                passo1: dadosPasso1,
                produtos: produtos,
                frete: custoFreteInput.value || '',
                passoAtual: passo2Div.style.display === 'none' ? 1 : 2,
                propostaId: propostaId,
                contadorItens: contadorItens,
                timestamp: new Date().getTime(),
                expiresAt: new Date().getTime() + (EXPIRY_HOURS * 60 * 60 * 1000)
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(dadosSessao));
            console.log('Sessão salva automaticamente');
        } catch (error) {
            console.error('Erro ao salvar sessão:', error);
        }
    }

    // Função para verificar se existe sessão válida
    function verificarSessaoExistente() {
        try {
            const dadosSalvos = localStorage.getItem(STORAGE_KEY);
            if (!dadosSalvos) return null;

            const sessao = JSON.parse(dadosSalvos);
            const agora = new Date().getTime();

            // Verificar se a sessão expirou
            if (agora > sessao.expiresAt) {
                localStorage.removeItem(STORAGE_KEY);
                return null;
            }

            return sessao;
        } catch (error) {
            console.error('Erro ao verificar sessão:', error);
            localStorage.removeItem(STORAGE_KEY);
            return null;
        }
    }

    // Função para restaurar dados da sessão
    function restaurarSessao(sessao) {
        try {
            // Restaurar dados do Passo 1
            if (sessao.passo1) {
                Object.keys(sessao.passo1).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = sessao.passo1[key];
                    }
                });
            }

            // Restaurar proposta ID e contador
            if (sessao.propostaId) {
                propostaId = sessao.propostaId;
            }
            if (sessao.contadorItens) {
                contadorItens = sessao.contadorItens;
            }

            // Restaurar produtos
            if (sessao.produtos && sessao.produtos.length > 0) {
                produtosTableBody.innerHTML = '';
                sessao.produtos.forEach(produto => {
                    if (produto.nome || produto.marca_modelo) { // Só restaurar se tiver dados
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td><input type="text" class="form-control form-control-sm text-center" name="numero_item" value="${produto.numero_item || ''}" required></td>
                            <td><input type="text" class="form-control form-control-sm" name="nome" value="${produto.nome || ''}" required></td>
                            <td><input type="text" class="form-control form-control-sm" name="marca_modelo" value="${produto.marca_modelo || ''}" required></td>
                            <td><input type="text" class="form-control form-control-sm money-input" name="custo" value="${produto.custo || ''}" required></td>
                            <td><input type="number" class="form-control form-control-sm" name="quantidade" value="${produto.quantidade || ''}" required></td>
                            <td><input type="text" class="form-control form-control-sm" name="unidade_medida" value="${produto.unidade_medida || ''}" required></td>
                            <td><input type="text" class="form-control form-control-sm money-input" name="referencia" value="${produto.referencia || ''}"></td>
                            <td><input type="text" class="form-control form-control-sm money-input" name="venda" value="${produto.venda || ''}" required></td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removerLinha(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        produtosTableBody.appendChild(row);

                        // Configurar eventos
                        configurarEventosLinha(row);
                    }
                });
            }

            // Restaurar frete
            if (sessao.frete) {
                custoFreteInput.value = sessao.frete;
            }

            // Restaurar passo atual
            if (sessao.passoAtual === 2) {
                passo1Div.style.display = "none";
                passo2Div.style.display = "block";
                atualizarPasso(2);
            }

            // Recalcular resumos
            calcularResumos();

            mostrarToast('Sucesso', 'Sessão restaurada com sucesso!', 'success');
        } catch (error) {
            console.error('Erro ao restaurar sessão:', error);
            mostrarToast('Erro', 'Erro ao restaurar sessão anterior.', 'danger');
        }
    }

    // Função para limpar sessão
    function limparSessao() {
        try {
            localStorage.removeItem(STORAGE_KEY);
            console.log('Sessão limpa');
        } catch (error) {
            console.error('Erro ao limpar sessão:', error);
        }
    }

    // Função para mostrar modal de recuperação
    function mostrarModalRecuperacao(sessao) {
        const modal = new bootstrap.Modal(document.getElementById('modalRecuperacao'));

        // Preparar informações dos dados encontrados
        let dadosInfo = [];
        if (sessao.passo1 && sessao.passo1.razao_social) {
            dadosInfo.push(`Empresa: ${sessao.passo1.razao_social}`);
        }
        if (sessao.produtos && sessao.produtos.length > 0) {
            dadosInfo.push(`${sessao.produtos.length} produto(s)`);
        }
        if (sessao.passoAtual) {
            dadosInfo.push(`Passo ${sessao.passoAtual}`);
        }

        document.getElementById('dadosEncontrados').textContent = dadosInfo.join(', ') || 'Dados de precificação';

        // Event listeners para os botões
        document.getElementById('btnContinuarSession').onclick = () => {
            modal.hide();
            restaurarSessao(sessao);
        };

        document.getElementById('btnNovaSession').onclick = () => {
            modal.hide();
            limparSessao();
            mostrarToast('Info', 'Nova precificação iniciada.', 'info');
        };

        modal.show();
    }

    // ===== FUNÇÕES ORIGINAIS =====

    // Função para mostrar toast
    function mostrarToast(titulo, mensagem, tipo) {
        const toastContainer = document.querySelector('.toast-container');
        const toastId = 'toast-' + Date.now();

        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${tipo} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${titulo}</strong><br>${mensagem}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();

        setTimeout(() => {
            const toast = document.getElementById(toastId);
            if (toast) toast.remove();
        }, 5000);
    }

    // Função para atualizar indicador de passo
    function atualizarPasso(passo) {
        document.getElementById('passoAtual').textContent = `Passo ${passo}`;
        salvarSessao(); // Salvar sempre que mudar de passo
    }

    // Função para carregar o imposto da base
    async function carregarImposto() {
        try {
            console.log("Carregando imposto...");
            const response = await fetch("/precificaja/api/imposto", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.error || `Erro ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            impostoVenda = data.imposto_venda || 0;
            console.log("Imposto carregado com sucesso:", impostoVenda);
        } catch (error) {
            console.error("Erro ao carregar o imposto:", error);
            mostrarToast('Aviso', 'Erro ao carregar imposto. Valor padrão de 0% será usado.', 'warning');
            impostoVenda = 0;
        }
    }

    // Função para consultar o CNPJ
    async function consultarCNPJ() {
        const cnpjInput = document.getElementById("cnpj");
        const cnpj = cnpjInput.value.trim();

        if (!cnpj) {
            mostrarToast('Atenção', 'Por favor, digite um CNPJ.', 'warning');
            return;
        }

        try {
            mostrarToast('Aguarde', 'Consultando CNPJ...', 'info');
            const response = await fetch("/precificaja/api/consultar_cnpj", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cnpj }),
                credentials: "include"
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.error || `Erro ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            document.getElementById("razao_social").value = data.razao_social || "";
            document.getElementById("endereco").value = data.endereco || "";
            mostrarToast('Sucesso', 'CNPJ consultado com sucesso!', 'success');

            // Salvar após consulta
            salvarSessao();
        } catch (error) {
            console.error("Erro ao consultar CNPJ:", error);
            mostrarToast('Erro', `Erro ao consultar CNPJ: ${error.message}`, 'danger');
        }
    }

    // Função para salvar o Passo 1
    async function salvarPasso1() {
        const formData = new FormData(document.getElementById("formPasso1"));
        const data = Object.fromEntries(formData.entries());

        try {
            mostrarToast('Aguarde', 'Salvando dados...', 'info');
            const response = await fetch("/precificaja/calculadora/salvar_passo1", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: "include"
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.error || `Erro ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            propostaId = result.proposta_id;

            // Transição para o Passo 2
            passo1Div.style.display = "none";
            passo2Div.style.display = "block";
            atualizarPasso(2);

            mostrarToast('Sucesso', 'Passo 1 salvo com sucesso!', 'success');
            salvarSessao(); // Salvar após avançar
        } catch (error) {
            console.error("Erro ao salvar Passo 1:", error);
            mostrarToast('Erro', `Erro ao salvar: ${error.message}`, 'danger');
        }
    }

    // Função para configurar eventos de uma linha
    function configurarEventosLinha(row) {
        const inputs = row.querySelectorAll('input');

        // Configurar busca automática no campo nome
        configurarBuscaProduto(inputs[1]);

        // Aplicar máscara de moeda nos campos monetários
        aplicarMascaraMoeda(inputs[3]); // Custo
        aplicarMascaraMoeda(inputs[6]); // Referência
        aplicarMascaraMoeda(inputs[7]); // Venda

        // Eventos para recalcular e salvar
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                calcularResumos();
                salvarSessao();
            });
        });
    }

    // Função para adicionar linha de produto - CORRIGIDA
    function adicionarLinhaProduto() {
        contadorItens++;
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="text" class="form-control form-control-sm text-center" name="numero_item" value="${contadorItens}" required></td>
            <td><input type="text" class="form-control form-control-sm" name="nome" required></td>
            <td><input type="text" class="form-control form-control-sm" name="marca_modelo" required></td>
            <td><input type="text" class="form-control form-control-sm money-input" name="custo" required></td>
            <td><input type="number" class="form-control form-control-sm" name="quantidade" required></td>
            <td><input type="text" class="form-control form-control-sm" name="unidade_medida" required></td>
            <td><input type="text" class="form-control form-control-sm money-input" name="referencia"></td>
            <td><input type="text" class="form-control form-control-sm money-input" name="venda" required></td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removerLinha(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        produtosTableBody.appendChild(row);

        // Configurar eventos da nova linha
        configurarEventosLinha(row);

        mostrarToast('Sucesso', 'Produto adicionado!', 'success');
        salvarSessao(); // Salvar após adicionar produto
    }

    // Função para remover linha
    window.removerLinha = function(button) {
        button.closest('tr').remove();
        calcularResumos();
        salvarSessao(); // Salvar após remover
        mostrarToast('Sucesso', 'Produto removido!', 'success');
    };

    // Função para calcular resumos - CORRIGIDA COM FRETE E LUCRO
    function calcularResumos() {
        const rows = produtosTableBody.querySelectorAll('tr');
        let custoTotal = 0;
        let quantidadeTotal = 0;
        let referenciaTotal = 0;
        let vendaTotal = 0;

        resumosContainer.innerHTML = '';

        // Calcular totais primeiro
        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input');
            const custo = moedaParaNumero(inputs[3].value) || 0;
            const quantidade = parseFloat(inputs[4].value) || 0;
            const referencia = moedaParaNumero(inputs[6].value) || 0;
            const venda = moedaParaNumero(inputs[7].value) || 0;

            const custoItem = custo * quantidade;
            const referenciaItem = referencia * quantidade;
            const vendaItem = venda * quantidade;

            custoTotal += custoItem;
            quantidadeTotal += quantidade;
            referenciaTotal += referenciaItem;
            vendaTotal += vendaItem;
        });

        const frete = moedaParaNumero(custoFreteInput.value) || 0;
        const impostoTotal = vendaTotal * (impostoVenda / 100);

        // Criar resumos individuais com frete proporcional e % lucro
        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input');
            const numeroItem = inputs[0].value || `${index + 1}`;
            const nome = inputs[1].value || `Produto ${index + 1}`;
            const custo = moedaParaNumero(inputs[3].value) || 0;
            const quantidade = parseFloat(inputs[4].value) || 0;
            const venda = moedaParaNumero(inputs[7].value) || 0;

            const custoItem = custo * quantidade;
            const vendaItem = venda * quantidade;

            // Calcular frete proporcional baseado no valor de venda
            const freteProporcional = vendaTotal > 0 ? (vendaItem / vendaTotal) * frete : 0;

            // Calcular imposto proporcional
            const impostoProporcional = vendaItem * (impostoVenda / 100);

            // Calcular lucro do item
            const lucroItem = vendaItem - custoItem - freteProporcional - impostoProporcional;

            // Calcular % de lucro
            const percentualLucro = vendaItem > 0 ? (lucroItem / vendaItem) * 100 : 0;

            // Criar resumo individual
            if (nome && quantidade > 0) {
                const resumoCard = document.createElement('div');
                resumoCard.className = 'col-md-6 col-lg-4 mb-3';
                resumoCard.innerHTML = `
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">Item ${numeroItem}: ${nome}</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm mb-0">
                                <tr>
                                    <td><strong>Quantidade:</strong></td>
                                    <td class="text-end">${quantidade}</td>
                                </tr>
                                <tr>
                                    <td><strong>Custo Unit:</strong></td>
                                    <td class="text-end">${formatarMoeda(custo)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Custo Total:</strong></td>
                                    <td class="text-end">${formatarMoeda(custoItem)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Frete Prop:</strong></td>
                                    <td class="text-end">${formatarMoeda(freteProporcional)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Imposto:</strong></td>
                                    <td class="text-end">${formatarMoeda(impostoProporcional)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Venda Total:</strong></td>
                                    <td class="text-end">${formatarMoeda(vendaItem)}</td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>Lucro:</strong></td>
                                    <td class="text-end"><strong>${formatarMoeda(lucroItem)}</strong></td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>% Lucro:</strong></td>
                                    <td class="text-end"><strong>${percentualLucro.toFixed(1)}%</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
                resumosContainer.appendChild(resumoCard);
            }
        });

        const lucroTotal = vendaTotal - custoTotal - frete - impostoTotal;

        // Atualizar resumo total com formatação de moeda
        document.getElementById('custoTotal').textContent = formatarMoeda(custoTotal);
        document.getElementById('quantidadeTotal').textContent = quantidadeTotal;
        document.getElementById('referenciaTotal').textContent = formatarMoeda(referenciaTotal);
        document.getElementById('valorVendaTotal').textContent = formatarMoeda(vendaTotal);
        document.getElementById('impostoTotal').textContent = formatarMoeda(impostoTotal);
        document.getElementById('lucroTotal').textContent = formatarMoeda(lucroTotal);

        // Mostrar/ocultar resumos individuais
        resumosIndividuais.style.display = resumosContainer.children.length > 0 ? 'block' : 'none';
    }

    // Função para finalizar precificação - CORRIGIDA
    async function finalizarPrecificacao() {
        const rows = produtosTableBody.querySelectorAll('tr');
        const produtos = [];

        for (const row of rows) {
            const inputs = row.querySelectorAll('input');
            const produto = {
                numero_item: inputs[0].value, // Campo editável
                nome: inputs[1].value,
                marca_modelo: inputs[2].value,
                custo: moedaParaNumero(inputs[3].value) || 0,
                quantidade: parseInt(inputs[4].value) || 0,
                unidade_medida: inputs[5].value,
                referencia: moedaParaNumero(inputs[6].value) || 0,
                venda: moedaParaNumero(inputs[7].value) || 0
            };

            if (!produto.nome || !produto.marca_modelo || produto.quantidade <= 0) {
                document.getElementById('mensagemErro').classList.remove('d-none');
                mostrarToast('Erro', 'Preencha todos os campos obrigatórios!', 'danger');
                return;
            }

            produtos.push(produto);
        }

        if (produtos.length === 0) {
            mostrarToast('Atenção', 'Adicione pelo menos um produto!', 'warning');
            return;
        }

        const data = {
            proposta_id: propostaId,
            produtos: produtos,
            frete: moedaParaNumero(custoFreteInput.value) || 0
        };

        try {
            mostrarToast('Aguarde', 'Finalizando precificação...', 'info');
            const response = await fetch("/precificaja/calculadora/salvar_passo2", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: "include"
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.error || `Erro ${response.status}: ${response.statusText}`);
            }

            // Limpar sessão após finalizar com sucesso
            limparSessao();
            mostrarToast('Sucesso', 'Precificação finalizada com sucesso!', 'success');

            setTimeout(() => {
                window.location.href = "/precificaja/simulacao";
            }, 2000);
        } catch (error) {
            console.error("Erro ao finalizar:", error);
            mostrarToast('Erro', `Erro ao finalizar: ${error.message}`, 'danger');
        }
    }

(function() {
    'use strict';

    let dadosEdital = null;
    let observerPasso2 = null;

    console.log('🔧 Script FINAL CORRETO carregado (v4.0)');

    function verificarOrigem() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('source') === 'edital';
    }

    async function buscarDadosEdital() {
        try {
            console.log('📥 Buscando dados do edital...');
            const response = await fetch('/precificaja/api/get_edital_data');
            const result = await response.json();

            if (result.success && result.data) {
                console.log('✅ Dados recebidos:', result.data);
                dadosEdital = result.data;
                return result.data;
            }
            return null;
        } catch (error) {
            console.error('❌ Erro:', error);
            return null;
        }
    }

    function mostrarNotificacao(mensagem, tipo = 'info') {
        const cores = {
            'success': 'alert-success',
            'info': 'alert-info',
            'warning': 'alert-warning',
            'error': 'alert-danger'
        };

        const icones = {
            'success': 'fa-check-circle',
            'info': 'fa-info-circle',
            'warning': 'fa-exclamation-triangle',
            'error': 'fa-times-circle'
        };

        const toast = document.createElement('div');
        toast.className = `alert ${cores[tipo]} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        toast.innerHTML = `
            <i class="fas ${icones[tipo]} me-2"></i>
            <strong>${mensagem}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function preencherCampo(seletor, valor) {
        const campo = document.querySelector(seletor);
        if (campo && valor) {
            campo.value = valor;
            campo.dispatchEvent(new Event('input', { bubbles: true }));
            campo.dispatchEvent(new Event('change', { bubbles: true }));
            return true;
        }
        return false;
    }

    function verificarCamposObrigatorios() {
        const campos = ['#cnpj', '#razao_social', '#endereco', '#numero_processo', '#validade_proposta', '#prazo_pagamento', '#prazo_entrega'];

        for (const seletor of campos) {
            const campo = document.querySelector(seletor);
            if (!campo || !campo.value || campo.value.trim() === '') {
                console.log(`⚠️  Campo vazio: ${seletor}`);
                return false;
            }
        }
        return true;
    }

    function preencherPasso1(dados) {
        const info = dados.informacoes_gerais || {};
        let preenchidos = 0;

        console.log('📝 Preenchendo Passo 1...');

        if (info.cnpj && preencherCampo('#cnpj', info.cnpj)) {
            console.log('  ✓ CNPJ:', info.cnpj);
            preenchidos++;
        }

        if (info.razao_social && preencherCampo('#razao_social', info.razao_social)) {
            console.log('  ✓ Razão Social');
            preenchidos++;
        }

        if (info.endereco && preencherCampo('#endereco', info.endereco)) {
            console.log('  ✓ Endereço');
            preenchidos++;
        }

        if (info.numero_processo && preencherCampo('#numero_processo', info.numero_processo)) {
            console.log('  ✓ Nº Processo');
            preenchidos++;
        }

        if (info.validade_proposta && preencherCampo('#validade_proposta', info.validade_proposta)) {
            console.log('  ✓ Validade:', info.validade_proposta);
            preenchidos++;
        }

        if (info.prazo_pagamento && preencherCampo('#prazo_pagamento', info.prazo_pagamento)) {
            console.log('  ✓ Prazo Pagamento:', info.prazo_pagamento);
            preenchidos++;
        }

        if (info.prazo_entrega && preencherCampo('#prazo_entrega', info.prazo_entrega)) {
            console.log('  ✓ Prazo Entrega:', info.prazo_entrega);
            preenchidos++;
        }

        console.log(`✅ ${preenchidos}/7 campos preenchidos`);

        const completo = verificarCamposObrigatorios();

        if (completo) {
            mostrarNotificacao('Dados importados! Avançando...', 'success');
            return true;
        } else {
            mostrarNotificacao('Dados parciais. Complete os campos.', 'warning');
            return false;
        }
    }

    function isPasso2Visivel() {
        const passo2 = document.getElementById('passo2');
        if (passo2) {
            const estilo = window.getComputedStyle(passo2);
            return estilo.display !== 'none';
        }
        return false;
    }

    function monitorarPasso2() {
        console.log('👀 Monitorando Passo 2...');

        if (isPasso2Visivel()) {
            console.log('✅ Passo 2 já está visível!');
            setTimeout(() => preencherPasso2(dadosEdital), 500);
            return;
        }

        observerPasso2 = new MutationObserver(() => {
            if (isPasso2Visivel()) {
                console.log('✅ Passo 2 detectado!');
                observerPasso2.disconnect();
                setTimeout(() => preencherPasso2(dadosEdital), 500);
            }
        });

        observerPasso2.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });

        console.log('✅ Observer ativado');
    }

    function preencherPasso2(dados) {
        const itens = dados.itens || [];

        if (itens.length === 0) {
            console.warn('⚠️  Nenhum item para preencher');
            return;
        }

        console.log(`📝 Iniciando preenchimento SEQUENCIAL de ${itens.length} itens...`);
        mostrarNotificacao(`Adicionando ${itens.length} produtos...`, 'info');

        // Adiciona produtos de forma SEQUENCIAL
        adicionarProdutosSequencialmente(itens, 0);
    }

    /**
     * Adiciona produtos um por vez, aguardando cada um terminar
     */
    async function adicionarProdutosSequencialmente(itens, index) {
        if (index >= itens.length) {
            console.log('✅ Todos os produtos foram adicionados!');
            mostrarNotificacao(`${itens.length} produtos adicionados!`, 'success');
            return;
        }

        const item = itens[index];
        const numero = index + 1;

        console.log(`\n🔹 Produto ${numero}/${itens.length}:`);
        console.log(`   Nome: ${item.descricao.substring(0, 50)}...`);
        console.log(`   Quantidade: ${item.quantidade}`);
        console.log(`   Unidade: ${item.unidade}`);
        console.log(`   Referência: ${item.valor_unitario}`);

        try {
            // Adiciona e preenche o produto
            await adicionarEPreencherProduto(item, numero);

            // Aguarda antes do próximo
            await sleep(1000);

            // Adiciona o próximo
            adicionarProdutosSequencialmente(itens, index + 1);

        } catch (error) {
            console.error(`   ❌ Erro ao adicionar produto ${numero}:`, error);
            // Continua com o próximo
            await sleep(1000);
            adicionarProdutosSequencialmente(itens, index + 1);
        }
    }

    /**
     * Adiciona e preenche um único produto
     */
    function adicionarEPreencherProduto(item, numero) {
        return new Promise((resolve, reject) => {
            // 1. Conta quantas linhas existem ANTES
            const linhasAntes = document.querySelectorAll('#produtosTableBody tr').length;
            console.log(`   📊 Linhas antes: ${linhasAntes}`);

            // 2. Clica no botão
            const botao = document.getElementById('lancarProduto');
            if (!botao) {
                console.error('   ❌ Botão #lancarProduto não encontrado!');
                reject('Botão não encontrado');
                return;
            }

            console.log('   ✓ Clicando em #lancarProduto...');
            botao.click();

            // 3. Aguarda a NOVA linha aparecer
            let tentativas = 0;
            const maxTentativas = 30;

            const intervalo = setInterval(() => {
                tentativas++;

                const linhasDepois = document.querySelectorAll('#produtosTableBody tr').length;

                if (linhasDepois > linhasAntes) {
                    clearInterval(intervalo);
                    console.log(`   ✅ Nova linha criada! (${linhasDepois} linhas total)`);

                    // 4. Pega a ÚLTIMA linha (a nova)
                    const linhas = document.querySelectorAll('#produtosTableBody tr');
                    const ultimaLinha = linhas[linhas.length - 1];

                    // 5. Aguarda os campos estarem prontos
                    setTimeout(() => {
                        const sucesso = preencherCamposLinha(ultimaLinha, item, numero);
                        if (sucesso) {
                            resolve();
                        } else {
                            reject('Falha ao preencher');
                        }
                    }, 500);

                } else if (tentativas >= maxTentativas) {
                    clearInterval(intervalo);
                    console.error(`   ❌ Timeout: Nova linha não foi criada`);
                    reject('Timeout');
                }
            }, 200);
        });
    }

    /**
     * Preenche os campos da linha usando name em vez de class
     */
    function preencherCamposLinha(linha, item, numero) {
        console.log(`   📝 Preenchendo campos...`);

        let preenchidos = 0;

        // Nome do Produto - input[name="nome"]
        const campoNome = linha.querySelector('input[name="nome"]');
        if (campoNome && item.descricao) {
            campoNome.value = item.descricao;
            campoNome.dispatchEvent(new Event('input', { bubbles: true }));
            campoNome.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('   ✓ Nome preenchido');
            preenchidos++;
        } else {
            console.error('   ❌ Campo input[name="nome"] não encontrado');
        }

        // Quantidade - input[name="quantidade"]
        const campoQtd = linha.querySelector('input[name="quantidade"]');
        if (campoQtd && item.quantidade) {
            let qtd = item.quantidade.toString().replace(/[^\d.,]/g, '').replace(',', '.');
            campoQtd.value = qtd;
            campoQtd.dispatchEvent(new Event('input', { bubbles: true }));
            campoQtd.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`   ✓ Quantidade preenchida: ${qtd}`);
            preenchidos++;
        } else {
            console.error('   ❌ Campo input[name="quantidade"] não encontrado');
        }

        // Unidade - input[name="unidade_medida"]
        const campoUnidade = linha.querySelector('input[name="unidade_medida"]');
        if (campoUnidade && item.unidade) {
            campoUnidade.value = item.unidade.toUpperCase();
            campoUnidade.dispatchEvent(new Event('input', { bubbles: true }));
            campoUnidade.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`   ✓ Unidade preenchida: ${item.unidade}`);
            preenchidos++;
        } else {
            console.error('   ❌ Campo input[name="unidade_medida"] não encontrado');
        }

        // Valor de Referência - input[name="referencia"]
        const campoReferencia = linha.querySelector('input[name="referencia"]');
        if (campoReferencia && item.valor_unitario) {
            let valor = item.valor_unitario.toString();
            valor = valor.replace(/R\$\s*/g, '');
            valor = valor.replace(/[^\d.,]/g, '');
            valor = valor.replace(',', '.');

            campoReferencia.value = valor;
            campoReferencia.dispatchEvent(new Event('input', { bubbles: true }));
            campoReferencia.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`   ✓ Referência preenchida: ${valor}`);
            preenchidos++;
        } else {
            console.error('   ❌ Campo input[name="referencia"] não encontrado');
        }

        console.log(`   ✅ Produto ${numero}: ${preenchidos}/4 campos preenchidos\n`);

        return preenchidos === 4;
    }

    /**
     * Função auxiliar para aguardar
     */
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function avancarParaPasso2() {
        console.log('⏭️  Tentando avançar para Passo 2...');

        const botao = document.getElementById('btnSalvarPasso1');

        if (botao) {
            setTimeout(() => {
                botao.click();
                console.log('✅ Botão #btnSalvarPasso1 clicado');
                monitorarPasso2();
            }, 800);
        } else {
            console.warn('⚠️  Botão #btnSalvarPasso1 não encontrado');
            monitorarPasso2();
        }
    }

    async function inicializar() {
        if (!verificarOrigem()) {
            console.log('ℹ️  Não veio do leitor de editais');
            return;
        }

        console.log('🚀 Iniciando preenchimento automático FINAL CORRETO (v4.0)...');

        const dados = await buscarDadosEdital();
        if (!dados) {
            mostrarNotificacao('Erro ao carregar dados', 'error');
            return;
        }

        const completo = preencherPasso1(dados);

        if (completo) {
            avancarParaPasso2();
        } else {
            monitorarPasso2();
        }

        const url = new URL(window.location);
        url.searchParams.delete('source');
        window.history.replaceState({}, '', url);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        inicializar();
    }

})();
    // ===== INICIALIZAÇÃO =====

    // Event Listeners
    document.getElementById("consultarCNPJ").addEventListener("click", consultarCNPJ);
    salvarPasso1Button.addEventListener("click", salvarPasso1);
    document.getElementById("lancarProduto").addEventListener("click", adicionarLinhaProduto);
    finalizarButton.addEventListener("click", finalizarPrecificacao);

    // Configurar máscara de moeda no campo frete
    aplicarMascaraMoeda(custoFreteInput);
    custoFreteInput.addEventListener("input", () => {
        calcularResumos();
        salvarSessao();
    });

    // Event listeners para salvamento automático no Passo 1
    const formPasso1 = document.getElementById('formPasso1');
    if (formPasso1) {
        const inputs = formPasso1.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', salvarSessao);
        });
    }



document.addEventListener('DOMContentLoaded', function() {
    let productCounter = 0;

    // Função para adicionar uma nova linha de produto
    document.getElementById('lancarProduto').addEventListener('click', function() {
        productCounter++;
        const tableBody = document.getElementById('produtosTableBody');
        const newRow = tableBody.insertRow();
        newRow.id = `productRow_${productCounter}`;

        newRow.innerHTML = `
            <td>${productCounter}</td>
            <td class="product-name-cell"><input type="text" class="form-control product-name-input" placeholder="Nome do Produto" list="productSuggestions_${productCounter}" data-product-id="${productCounter}"><datalist id="productSuggestions_${productCounter}"></datalist></td>
            <td><input type="text" class="form-control product-brand-model" placeholder="Marca/Modelo" readonly></td>
            <td><input type="number" class="form-control product-cost" placeholder="0.00" step="0.01"></td>
            <td><input type="number" class="form-control product-quantity" placeholder="1" min="1"></td>
            <td><input type="text" class="form-control product-unit" placeholder="Unidade"></td>
            <td><input type="number" class="form-control product-reference" placeholder="0.00" step="0.01"></td>
            <td><input type="number" class="form-control product-sale" placeholder="0.00" step="0.01"></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-product"><i class="fas fa-trash"></i></button></td>
        `;

        // Adicionar evento para remover produto
        newRow.querySelector('.remove-product').addEventListener('click', function() {
            newRow.remove();
            // Reindexar os produtos se necessário
        });

        // Adicionar evento de input para a busca de produtos
        const productNameInput = newRow.querySelector('.product-name-input');
        const productSuggestionsDatalist = newRow.querySelector(`#productSuggestions_${productCounter}`);
        const productBrandModelInput = newRow.querySelector('.product-brand-model');
        const productCostInput = newRow.querySelector('.product-cost');
        const productUnitInput = newRow.querySelector('.product-unit');

        productNameInput.addEventListener('input', function() {
            const searchTerm = this.value;
            if (searchTerm.length < 3) {
                productSuggestionsDatalist.innerHTML = '';
                return;
            }

            fetch(`/precificaja/api/buscar_produtos?q=${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    productSuggestionsDatalist.innerHTML = '';
                    data.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.nome;
                        option.setAttribute('data-id', product.id);
                        option.setAttribute('data-marca_modelo', product.marca_modelo);
                        option.setAttribute('data-custo', product.custo);
                        option.setAttribute('data-unidade_medida', product.unidade_medida || ''); // Adicionado unidade_medida
                        productSuggestionsDatalist.appendChild(option);
                    });
                })
                .catch(error => console.error('Erro ao buscar produtos:', error));
        });

        // Adicionar evento de 'change' para preencher os campos quando um produto é selecionado do datalist
        productNameInput.addEventListener('change', function() {
            const selectedOption = Array.from(productSuggestionsDatalist.options).find(option => option.value === this.value);
            if (selectedOption) {
                productBrandModelInput.value = selectedOption.getAttribute('data-marca_modelo');
                productCostInput.value = selectedOption.getAttribute('data-custo');
                productUnitInput.value = selectedOption.getAttribute('data-unidade_medida'); // Preenche unidade de medida
            }
        });
    });

    // Lógica para salvar o Passo 1 e avançar para o Passo 2
    document.getElementById('salvarPasso1').addEventListener('click', function() {
        // Aqui você adicionaria a lógica para coletar os dados do Passo 1 e enviá-los para o backend
        // Por enquanto, apenas avança para o Passo 2
        document.getElementById('passo1').style.display = 'none';
        document.getElementById('passo2').style.display = 'block';
        document.getElementById('passoAtual').textContent = 'Passo 2';
    });
});




    // Verificar sessão existente ao carregar a página
    const sessaoExistente = verificarSessaoExistente();
    if (sessaoExistente) {
        // Aguardar um pouco para garantir que a página carregou completamente
        setTimeout(() => {
            mostrarModalRecuperacao(sessaoExistente);
        }, 500);
    }

    // Carregar imposto ao inicializar
    carregarImposto();

    // Salvar sessão periodicamente (a cada 30 segundos)
    setInterval(salvarSessao, 30000);

    // Salvar sessão antes de sair da página
    window.addEventListener('beforeunload', salvarSessao);
});

</script>

{% endblock %}

